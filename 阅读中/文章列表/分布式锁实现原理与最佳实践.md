---
source: https://mp.weixin.qq.com/s/JzCHpIOiFVmBoAko58ZuGw
create: 2023-11-21 09:47
---

# åˆ†å¸ƒå¼é”å®ç°åŸç†ä¸æœ€ä½³å®è·µ

![](https://mmbiz.qpic.cn/mmbiz_jpg/Z6bicxIx5naLAqrZcPnhaDjod6q67MoQvpYub85MwNcr2GcZXp5I6jOCwTxpnGibl3qzWdgQl7cLzOC4O4anvuDQ/640?wx_fmt=jpeg)  

é˜¿é‡Œå¦¹å¯¼è¯»

åœ¨å•ä½“çš„åº”ç”¨å¼€å‘åœºæ™¯ä¸­æ¶‰åŠå¹¶å‘åŒæ­¥æ—¶ï¼Œå¤§å®¶å¾€å¾€é‡‡ç”¨ Synchronizedï¼ˆåŒæ­¥ï¼‰æˆ–åŒä¸€ä¸ª JVM å†… Lock æœºåˆ¶æ¥è§£å†³å¤šçº¿ç¨‹é—´çš„åŒæ­¥é—®é¢˜ã€‚è€Œåœ¨åˆ†å¸ƒå¼é›†ç¾¤å·¥ä½œçš„å¼€å‘åœºæ™¯ä¸­ï¼Œå°±éœ€è¦ä¸€ç§æ›´åŠ é«˜çº§çš„é”æœºåˆ¶æ¥å¤„ç†è·¨æœºå™¨çš„è¿›ç¨‹ä¹‹é—´çš„æ•°æ®åŒæ­¥é—®é¢˜ï¼Œè¿™ç§è·¨æœºå™¨çš„é”å°±æ˜¯åˆ†å¸ƒå¼é”ã€‚æ¥ä¸‹æ¥æœ¬æ–‡å°†ä¸ºå¤§å®¶åˆ†äº«åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µã€‚

ä¸€ã€è¶…å–é—®é¢˜å¤ç°

**1.1 ç°è±¡**

å­˜åœ¨å¦‚ä¸‹çš„å‡ å¼ è¡¨ï¼š

*   å•†å“è¡¨

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIEweAx24tZTzaib1ibA2fdWA7gJZsuuSkSxVP1TCSvUEtHWgL80UbAFuA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIGazuT7TdaHL8RTCgnicicZ3S16VfWQjZPMBjfaG0rPnSQWXCKJjWZDIQ/640?wx_fmt=png)

*   è®¢å•è¡¨

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHItlMUroSeyNyC7G7jDpZCBLqweBtdbXfntqfdDS0Orib8mOtUuoO2icZg/640?wx_fmt=png)

*   è®¢å• item è¡¨

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHISJxnFfc4UbIBC4WHAX5MEocWESAepDNIZ1yDO6MOw8uDHD4P0FYrUQ/640?wx_fmt=png)

å•†å“çš„åº“å­˜ä¸º 1ï¼Œä½†æ˜¯å¹¶å‘é«˜çš„æ—¶å€™æœ‰å¤šç¬”è®¢å•ã€‚

é”™è¯¯æ¡ˆä¾‹ä¸€ï¼šæ•°æ®åº“ update ç›¸äº’è¦†ç›–

ç›´æ¥åœ¨å†…å­˜ä¸­åˆ¤æ–­æ˜¯å¦æœ‰åº“å­˜ï¼Œè®¡ç®—æ‰£å‡ä¹‹åçš„å€¼æ›´æ–°æ•°æ®åº“ï¼Œå¹¶å‘çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´ç›¸äº’è¦†ç›–å‘ç”Ÿï¼š

```
@Transactional(rollbackFor = Exception.class)
public Long createOrder() throws Exception {
    Product product = productMapper.selectByPrimaryKey(purchaseProductId);
    // ... å¿½ç•¥æ ¡éªŒé€»è¾‘

    //å•†å“å½“å‰åº“å­˜
    Integer currentCount = product.getCount();
    //æ ¡éªŒåº“å­˜
    if (purchaseProductNum > currentCount) {
        throw new Exception("å•†å“" + purchaseProductId + "ä»…å‰©" + currentCount + "ä»¶ï¼Œæ— æ³•è´­ä¹°");
    }
    // è®¡ç®—å‰©ä½™åº“å­˜
    Integer leftCount = currentCount - purchaseProductNum;
    // æ›´æ–°åº“å­˜
    product.setCount(leftCount);
    product.setGmtModified(new Date());
    productMapper.updateByPrimaryKeySelective(product);

    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    orderItem.setOrderId(order.getId());
    // ... çœç•¥ Set
    return order.getId();
}
```

é”™è¯¯æ¡ˆä¾‹äºŒï¼šæ‰£å‡ä¸²è¡Œæ‰§è¡Œï¼Œä½†æ˜¯åº“å­˜è¢«æ‰£å‡ä¸ºè´Ÿæ•°

åœ¨ SQL ä¸­åŠ å…¥è¿ç®—é¿å…å€¼çš„ç›¸äº’è¦†ç›–ï¼Œä½†æ˜¯åº“å­˜çš„æ•°é‡å˜ä¸ºè´Ÿæ•°ï¼Œå› ä¸ºæ ¡éªŒåº“å­˜æ˜¯å¦è¶³å¤Ÿè¿˜æ˜¯åœ¨å†…å­˜ä¸­æ‰§è¡Œçš„ï¼Œå¹¶å‘æƒ…å†µä¸‹éƒ½ä¼šè¯»åˆ°æœ‰åº“å­˜ï¼š

```
@Transactional(rollbackFor = Exception.class)
public Long createOrder() throws Exception {
    Product product = productMapper.selectByPrimaryKey(purchaseProductId);
    // ... å¿½ç•¥æ ¡éªŒé€»è¾‘

    //å•†å“å½“å‰åº“å­˜
    Integer currentCount = product.getCount();
    //æ ¡éªŒåº“å­˜
    if (purchaseProductNum > currentCount) {
        throw new Exception("å•†å“" + purchaseProductId + "ä»…å‰©" + currentCount + "ä»¶ï¼Œæ— æ³•è´­ä¹°");
    }
    // ä½¿ç”¨ set count =  count - #{purchaseProductNum,jdbcType=INTEGER}, æ›´æ–°åº“å­˜
    productMapper.updateProductCount(purchaseProductNum,new Date(),product.getId());
    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    orderItem.setOrderId(order.getId());
    // ... çœç•¥ Set
    return order.getId();
}
```

é”™è¯¯æ¡ˆä¾‹ä¸‰ï¼šä½¿ç”¨ synchronized å®ç°å†…å­˜ä¸­ä¸²è¡Œæ ¡éªŒï¼Œä½†æ˜¯ä¾æ—§æ‰£å‡ä¸ºè´Ÿæ•°

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯äº‹åŠ¡çš„æ³¨è§£ï¼Œsynchronized åŠ åœ¨æ–¹æ³•ä¸Šï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸçš„æ—¶å€™é”å°±ä¼šé‡Šæ”¾ï¼Œæ­¤æ—¶çš„äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°è¿™æŠŠé”ä¹‹åå°±ä¼šæœ‰ä¸€æ¬¡æ‰£å‡ï¼Œå¯¼è‡´è´Ÿæ•°ã€‚

```
@Transactional(rollbackFor = Exception.class)
public synchronized Long createOrder() throws Exception {
    Product product = productMapper.selectByPrimaryKey(purchaseProductId);
    // ... å¿½ç•¥æ ¡éªŒé€»è¾‘

    //å•†å“å½“å‰åº“å­˜
    Integer currentCount = product.getCount();
    //æ ¡éªŒåº“å­˜
    if (purchaseProductNum > currentCount) {
        throw new Exception("å•†å“" + purchaseProductId + "ä»…å‰©" + currentCount + "ä»¶ï¼Œæ— æ³•è´­ä¹°");
    }
    // ä½¿ç”¨ set count =  count - #{purchaseProductNum,jdbcType=INTEGER}, æ›´æ–°åº“å­˜
    productMapper.updateProductCount(purchaseProductNum,new Date(),product.getId());
    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    orderItem.setOrderId(order.getId());
    // ... çœç•¥ Set
    return order.getId();
}
```

**1.2 è§£å†³åŠæ³•**

ä»ä¸Šé¢é€ æˆé—®é¢˜çš„åŸå› æ¥çœ‹ï¼Œåªè¦æ˜¯æ‰£å‡åº“å­˜çš„åŠ¨ä½œï¼Œä¸æ˜¯åŸå­æ€§çš„ã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œå°±ä¼šæœ‰é—®é¢˜ã€‚

*   å•ä½“åº”ç”¨ï¼šä½¿ç”¨æœ¬åœ°é” + æ•°æ®åº“ä¸­çš„è¡Œé”è§£å†³
    
*   åˆ†å¸ƒå¼åº”ç”¨ï¼š
*   ä½¿ç”¨æ•°æ®åº“ä¸­çš„ä¹è§‚é”ï¼ŒåŠ ä¸€ä¸ª version å­—æ®µï¼Œåˆ©ç”¨ CAS æ¥å®ç°ï¼Œä¼šå¯¼è‡´å¤§é‡çš„ update å¤±è´¥
    
*   ä½¿ç”¨æ•°æ®åº“ç»´æŠ¤ä¸€å¼ é”çš„è¡¨ + æ‚²è§‚é” selectï¼Œä½¿ç”¨ select for update å®ç°
    
*   ä½¿ç”¨ Redis çš„ setNX å®ç°åˆ†å¸ƒå¼é”
    
*   ä½¿ç”¨ zookeeper çš„ watcher + æœ‰åºä¸´æ—¶èŠ‚ç‚¹æ¥å®ç°å¯é˜»å¡çš„åˆ†å¸ƒå¼é”
    
*   ä½¿ç”¨ Redisson æ¡†æ¶å†…çš„åˆ†å¸ƒå¼é”æ¥å®ç°
    
*   ä½¿ç”¨ curator æ¡†æ¶å†…çš„åˆ†å¸ƒå¼é”æ¥å®ç°

äºŒã€å•ä½“åº”ç”¨è§£å†³è¶…å–çš„é—®é¢˜

**æ­£ç¡®ç¤ºä¾‹ï¼šå°†äº‹åŠ¡åŒ…å«åœ¨é”çš„æ§åˆ¶èŒƒå›´å†…**

ä¿è¯åœ¨é”é‡Šæ”¾ä¹‹å‰ï¼Œäº‹åŠ¡å·²ç»æäº¤ã€‚

```
//@Transactional(rollbackFor = Exception.class)
public synchronized Long createOrder() throws Exception {
    TransactionStatus transaction1 = platformTransactionManager.getTransaction(transactionDefinition);
    Product product = productMapper.selectByPrimaryKey(purchaseProductId);
    if (product == null) {
        platformTransactionManager.rollback(transaction1);
        throw new Exception("è´­ä¹°å•†å“ï¼š" + purchaseProductId + "ä¸å­˜åœ¨");
    }
    
    //å•†å“å½“å‰åº“å­˜
    Integer currentCount = product.getCount();
    //æ ¡éªŒåº“å­˜
    if (purchaseProductNum > currentCount) {
        platformTransactionManager.rollback(transaction1);
        throw new Exception("å•†å“" + purchaseProductId + "ä»…å‰©" + currentCount + "ä»¶ï¼Œæ— æ³•è´­ä¹°");
    }

    productMapper.updateProductCount(purchaseProductNum, new Date(), product.getId());

    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    orderItem.setOrderId(order.getId());
    // ... çœç•¥ Set
    return order.getId();
    platformTransactionManager.commit(transaction1);
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ synchronized çš„ä»£ç å—**

```
public Long createOrder() throws Exception {
    Product product = null;
    //synchronized (this) {
    //synchronized (object) {
    synchronized (DBOrderService2.class) {
        TransactionStatus transaction1 = platformTransactionManager.getTransaction(transactionDefinition);
        product = productMapper.selectByPrimaryKey(purchaseProductId);
        if (product == null) {
            platformTransactionManager.rollback(transaction1);
            throw new Exception("è´­ä¹°å•†å“ï¼š" + purchaseProductId + "ä¸å­˜åœ¨");
        }

        //å•†å“å½“å‰åº“å­˜
        Integer currentCount = product.getCount();
        System.out.println(Thread.currentThread().getName() + "åº“å­˜æ•°ï¼š" + currentCount);
        //æ ¡éªŒåº“å­˜
        if (purchaseProductNum > currentCount) {
            platformTransactionManager.rollback(transaction1);
            throw new Exception("å•†å“" + purchaseProductId + "ä»…å‰©" + currentCount + "ä»¶ï¼Œæ— æ³•è´­ä¹°");
        }

        productMapper.updateProductCount(purchaseProductNum, new Date(), product.getId());
        platformTransactionManager.commit(transaction1);
    }

    TransactionStatus transaction2 = platformTransactionManager.getTransaction(transactionDefinition);

    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    // ... çœç•¥ Set
    orderItemMapper.insertSelective(orderItem);
    platformTransactionManager.commit(transaction2);
    return order.getId();
```

**æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ Lock**

```
private Lock lock = new ReentrantLock();

public Long createOrder() throws Exception{  
    Product product = null;

    lock.lock();

    TransactionStatus transaction1 = platformTransactionManager.getTransaction(transactionDefinition);
    try {
        product = productMapper.selectByPrimaryKey(purchaseProductId);
        if (product==null){
            throw new Exception("è´­ä¹°å•†å“ï¼š"+purchaseProductId+"ä¸å­˜åœ¨");
        }

        //å•†å“å½“å‰åº“å­˜
        Integer currentCount = product.getCount();
        System.out.println(Thread.currentThread().getName()+"åº“å­˜æ•°ï¼š"+currentCount);
        //æ ¡éªŒåº“å­˜
        if (purchaseProductNum > currentCount){
            throw new Exception("å•†å“"+purchaseProductId+"ä»…å‰©"+currentCount+"ä»¶ï¼Œæ— æ³•è´­ä¹°");
        }

        productMapper.updateProductCount(purchaseProductNum,new Date(),product.getId());
        platformTransactionManager.commit(transaction1);
    } catch (Exception e) {
        platformTransactionManager.rollback(transaction1);
    } finally {
        // æ³¨æ„æŠ›å¼‚å¸¸çš„æ—¶å€™é”é‡Šæ”¾ä¸æ‰ï¼Œåˆ†å¸ƒå¼é”ä¹Ÿä¸€æ ·ï¼Œéƒ½è¦åœ¨è¿™é‡Œåˆ æ‰
        lock.unlock();
    }

    TransactionStatus transaction = platformTransactionManager.getTransaction(transactionDefinition);
    Order order = new Order();
    // ... çœç•¥ Set
    orderMapper.insertSelective(order);

    OrderItem orderItem = new OrderItem();
    // ... çœç•¥ Set
    orderItemMapper.insertSelective(orderItem);
    platformTransactionManager.commit(transaction);
    return order.getId();
}
```

ä¸‰ã€å¸¸è§åˆ†å¸ƒå¼é”çš„ä½¿ç”¨

ä¸Šé¢ä½¿ç”¨çš„æ–¹æ³•åªèƒ½è§£å†³å•ä½“é¡¹ç›®ï¼Œå½“éƒ¨ç½²å¤šå°æœºå™¨çš„æ—¶å€™å°±ä¼šå¤±æ•ˆï¼Œå› ä¸ºé”æœ¬èº«å°±æ˜¯å•æœºçš„é”ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥å®ç°ã€‚

**3.1 æ•°æ®åº“ä¹è§‚é”**

æ•°æ®åº“ä¸­çš„ä¹è§‚é”ï¼ŒåŠ ä¸€ä¸ª version å­—æ®µï¼Œåˆ©ç”¨ CAS æ¥å®ç°ï¼Œä¹è§‚é”çš„æ–¹å¼æ”¯æŒå¤šå°æœºå™¨å¹¶å‘å®‰å…¨ã€‚ä½†æ˜¯å¹¶å‘é‡å¤§çš„æ—¶å€™ä¼šå¯¼è‡´å¤§é‡çš„ update å¤±è´¥

**3.2 æ•°æ®åº“åˆ†å¸ƒå¼é”**

db æ“ä½œæ€§èƒ½è¾ƒå·®ï¼Œå¹¶ä¸”æœ‰é”è¡¨çš„é£é™©ï¼Œä¸€èˆ¬ä¸è€ƒè™‘ã€‚

3.2.1 ç®€å•çš„æ•°æ®åº“é”

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIe4XJSbUNsJqtlmxOJxMzicGq32zeGq0We0BcpEJu2cAK4jN0t31Q0nA/640?wx_fmt=jpeg)

select for update

ç›´æ¥åœ¨æ•°æ®åº“æ–°å»ºä¸€å¼ è¡¨ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIGSicTk8VuLJ7sMnKW9LS5NwZTJMuZ4Vj7wlQicjP4Lko9SkooM6iaGQfQ/640?wx_fmt=png)

é”çš„ code é¢„å…ˆå†™åˆ°æ•°æ®åº“ä¸­ï¼ŒæŠ¢é”çš„æ—¶å€™ï¼Œä½¿ç”¨ select for update æŸ¥è¯¢é”å¯¹åº”çš„ keyï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„ codeï¼Œé˜»å¡å°±è¯´æ˜åˆ«äººåœ¨ä½¿ç”¨é”ã€‚

```
// åŠ ä¸Šäº‹åŠ¡å°±æ˜¯ä¸ºäº† for update çš„é”å¯ä»¥ä¸€ç›´ç”Ÿæ•ˆåˆ°äº‹åŠ¡æ‰§è¡Œç»“æŸ
// é»˜è®¤å›æ»šçš„æ˜¯ RunTimeException
@Transactional(rollbackFor = Exception.class)
public String singleLock() throws Exception {
    log.info("æˆ‘è¿›å…¥äº†æ–¹æ³•ï¼");
    DistributeLock distributeLock = distributeLockMapper.
        selectDistributeLock("demo");
    if (distributeLock==null) {
        throw new Exception("åˆ†å¸ƒå¼é”æ‰¾ä¸åˆ°");
    }
    log.info("æˆ‘è¿›å…¥äº†é”ï¼");
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "æˆ‘å·²ç»æ‰§è¡Œå®Œæˆï¼";
}
```

```
<select id="selectDistributeLock" resultType="com.deltaqin.distribute.model.DistributeLock">
  select * from distribute_lock
  where businessCode = #{businessCode,jdbcType=VARCHAR}
  for update
</select>
```

ä½¿ç”¨å”¯ä¸€é”®ä½œä¸ºé™åˆ¶ï¼Œæ’å…¥ä¸€æ¡æ•°æ®ï¼Œå…¶ä»–å¾…æ‰§è¡Œçš„ SQL å°±ä¼šå¤±è´¥ï¼Œå½“æ•°æ®åˆ é™¤ä¹‹åå†å»è·å–é” ï¼Œè¿™æ˜¯åˆ©ç”¨äº†å”¯ä¸€ç´¢å¼•çš„æ’ä»–æ€§ã€‚

insert lock

ç›´æ¥ç»´æŠ¤ä¸€å¼ é”è¡¨ï¼š

```
@Autowired
private MethodlockMapper methodlockMapper;

@Override
public boolean tryLock() {
    try {
        //æ’å…¥ä¸€æ¡æ•°æ®   insert into
        methodlockMapper.insert(new Methodlock("lock"));
    }catch (Exception e){
        //æ’å…¥å¤±è´¥
        return false;
    }
    return true;
}

@Override
public void waitLock() {
    try {
        Thread.sleep(10);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}

@Override
public void unlock() {
    //åˆ é™¤æ•°æ®   delete
    methodlockMapper.deleteByMethodlock("lock");
    System.out.println("-------é‡Šæ”¾é”------");
}
```

**3.3 Redis setNx**

Redis åŸç”Ÿæ”¯æŒçš„ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªä¼šè¯å¯ä»¥è®¾ç½®æˆåŠŸï¼Œå› ä¸º Redis è‡ªå·±å°±æ˜¯å•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œçš„ã€‚

```
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

```
spring.redis.host=localhost
```

å°è£…ä¸€ä¸ªé”å¯¹è±¡ï¼š

```
@Slf4j
public class RedisLock implements AutoCloseable {

    private RedisTemplate redisTemplate;
    private String key;
    private String value;
    //å•ä½ï¼šç§’
    private int expireTime;

    /**
     * æ²¡æœ‰ä¼ é€’ valueï¼Œå› ä¸ºç›´æ¥ä½¿ç”¨çš„æ˜¯éšæœºå€¼
     */
    public RedisLock(RedisTemplate redisTemplate,String key,int expireTime){
        this.redisTemplate = redisTemplate;
        this.key = key;
        this.expireTime=expireTime;
        this.value = UUID.randomUUID().toString();
    }

    /**
     * JDK 1.7 ä¹‹åçš„è‡ªåŠ¨å…³é—­çš„åŠŸèƒ½
     */
    @Override
    public void close() throws Exception {
        unLock();
    }

    /**
     * è·å–åˆ†å¸ƒå¼é”
     * SET resource_name my_random_value NX PX 30000
     * æ¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”çš„éšæœºå€¼ my_random_value ä¸ä¸€æ ·ï¼Œç”¨äºé‡Šæ”¾é”çš„æ—¶å€™æ ¡éªŒ
     * NX è¡¨ç¤º key ä¸å­˜åœ¨çš„æ—¶å€™æˆåŠŸï¼Œkey å­˜åœ¨çš„æ—¶å€™è®¾ç½®ä¸æˆåŠŸï¼ŒRedis è‡ªå·±æ˜¯å•çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œçš„ï¼Œç¬¬ä¸€ä¸ªæ‰§è¡Œçš„æ‰å¯ä»¥è®¾ç½®æˆåŠŸ
     * PX è¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œå¿˜è®°åˆ é™¤ï¼Œå°±ä¼šæ°¸è¿œä¸è¿‡æœŸ
     */
    public boolean getLock(){
        RedisCallback<Boolean> redisCallback = connection -> {
            //è®¾ç½®NX
            RedisStringCommands.SetOption setOption = RedisStringCommands.SetOption.ifAbsent();
            //è®¾ç½®è¿‡æœŸæ—¶é—´
            Expiration expiration = Expiration.seconds(expireTime);
            //åºåˆ—åŒ–key
            byte[] redisKey = redisTemplate.getKeySerializer().serialize(key);
            //åºåˆ—åŒ–value
            byte[] redisValue = redisTemplate.getValueSerializer().serialize(value);
            //æ‰§è¡Œsetnxæ“ä½œ
            Boolean result = connection.set(redisKey, redisValue, expiration, setOption);
            return result;
        };

        //è·å–åˆ†å¸ƒå¼é”
        Boolean lock = (Boolean)redisTemplate.execute(redisCallback);
        return lock;
    }

    /**
     * é‡Šæ”¾é”çš„æ—¶å€™éšæœºæ•°ç›¸åŒçš„æ—¶å€™æ‰å¯ä»¥é‡Šæ”¾ï¼Œé¿å…é‡Šæ”¾äº†åˆ«äººè®¾ç½®çš„é”ï¼ˆè‡ªå·±çš„å·²ç»è¿‡æœŸäº†æ‰€ä»¥åˆ«äººæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼‰
     * é‡Šæ”¾çš„æ—¶å€™é‡‡ç”¨ LUA è„šæœ¬ï¼Œå› ä¸º delete æ²¡æœ‰åŸç”Ÿæ”¯æŒåˆ é™¤çš„æ—¶å€™æ ¡éªŒå€¼ï¼Œè¯æ˜æ˜¯å½“å‰çº¿ç¨‹è®¾ç½®è¿›å»çš„å€¼
     * è„šæœ¬æ˜¯åœ¨å®˜æ–¹æ–‡æ¡£é‡Œé¢æœ‰çš„
     */
    public boolean unLock() {
        // key æ˜¯è‡ªå·±æ‰å¯ä»¥é‡Šæ”¾ï¼Œä¸æ˜¯å°±ä¸èƒ½é‡Šæ”¾åˆ«äººçš„é”
        String script = "if redis.call(\"get\",KEYS[1]) == ARGV[1] then\n" +
                "    return redis.call(\"del\",KEYS[1])\n" +
                "else\n" +
                "    return 0\n" +
                "end";
        RedisScript<Boolean> redisScript = RedisScript.of(script,Boolean.class);
        List<String> keys = Arrays.asList(key);

        // æ‰§è¡Œè„šæœ¬çš„æ—¶å€™ä¼ é€’çš„ value å°±æ˜¯å¯¹åº”çš„å€¼
        Boolean result = (Boolean)redisTemplate.execute(redisScript, keys, value);
        log.info("é‡Šæ”¾é”çš„ç»“æœï¼š"+result);
        return result;
    }
}
```

æ¯æ¬¡è·å–çš„æ—¶å€™ï¼Œè‡ªå·±çº¿ç¨‹éœ€è¦ new å¯¹åº”çš„ RedisLockï¼š

```
public String redisLock(){
    log.info("æˆ‘è¿›å…¥äº†æ–¹æ³•ï¼");
    try (RedisLock redisLock = new RedisLock(redisTemplate,"redisKey",30)){
        if (redisLock.getLock()) {
            log.info("æˆ‘è¿›å…¥äº†é”ï¼ï¼");
            Thread.sleep(15000);
        }
    } catch (InterruptedException e) {
        e.printStackTrace();
    } catch (Exception e) {
        e.printStackTrace();
    }
    log.info("æ–¹æ³•æ‰§è¡Œå®Œæˆ");
    return "æ–¹æ³•æ‰§è¡Œå®Œæˆ";
}
```

**3.4 zookeeper ç¬æ—¶ znode èŠ‚ç‚¹ + watcher ç›‘å¬æœºåˆ¶**

ä¸´æ—¶èŠ‚ç‚¹å…·å¤‡æ•°æ®è‡ªåŠ¨åˆ é™¤çš„åŠŸèƒ½ã€‚å½“ client ä¸ ZooKeeper è¿æ¥å’Œ session æ–­æ‰æ—¶ï¼Œç›¸åº”çš„ä¸´æ—¶èŠ‚ç‚¹å°±ä¼šè¢«åˆ é™¤ã€‚zk æœ‰ç¬æ—¶å’ŒæŒä¹…èŠ‚ç‚¹ï¼Œç¬æ—¶èŠ‚ç‚¹ä¸å¯ä»¥æœ‰å­èŠ‚ç‚¹ã€‚ä¼šè¯ç»“æŸä¹‹åç¬æ—¶èŠ‚ç‚¹å°±ä¼šæ¶ˆå¤±ï¼ŒåŸºäº zk çš„ç¬æ—¶æœ‰åºèŠ‚ç‚¹å®ç°åˆ†å¸ƒå¼é”ï¼š

*   å¤šçº¿ç¨‹å¹¶å‘åˆ›å»ºç¬æ—¶èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¾—åˆ°æœ‰åºçš„åºåˆ—ï¼Œåºå·æœ€å°çš„çº¿ç¨‹å¯ä»¥è·å¾—é”ï¼›
    
*   å…¶ä»–çš„çº¿ç¨‹ç›‘å¬è‡ªå·±åºå·çš„å‰ä¸€ä¸ªåºå·ã€‚å‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸä¹‹ååˆ é™¤è‡ªå·±åºå·çš„èŠ‚ç‚¹ï¼›
    
*   ä¸‹ä¸€ä¸ªåºå·çš„çº¿ç¨‹å¾—åˆ°é€šçŸ¥ï¼Œç»§ç»­æ‰§è¡Œï¼›
    
*   ä»¥æ­¤ç±»æ¨ï¼Œåˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°±ç¡®è®¤äº†çº¿ç¨‹æ‰§è¡Œçš„é¡ºåºã€‚

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIN7yQzGTy0KgxwKID4o5MsDkFj8SISGLMwxhuDSAicpic4fQaaLIIQaeQ/640?wx_fmt=jpeg)

```
<dependency>
  <groupId>org.apache.zookeeper</groupId>
  <artifactId>zookeeper</artifactId>
  <version>3.4.14</version>
  <exclusions>
    <exclusion>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-log4j12</artifactId>
    </exclusion>
  </exclusions>
</dependency>
```

zk çš„è§‚å¯Ÿå™¨åªå¯ä»¥ç›‘æ§ä¸€æ¬¡ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–ä¹‹åå¯ä»¥å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä¹‹åéœ€è¦å†æ¬¡è®¾ç½®ç›‘æ§ã€‚existsã€createã€getChildren ä¸‰ä¸ªæ–¹æ³•éƒ½å¯ä»¥æ·»åŠ  watcher ï¼Œä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ä¼ é€’ true å°±æ˜¯æ·»åŠ ç›‘å¬ã€‚æ³¨æ„è¿™é‡Œ Lock å®ç°äº† Watcher å’Œ AutoCloseableï¼š

å½“å‰çº¿ç¨‹åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±è·å¾—é”ï¼Œå¦åˆ™å°±ç›‘å¬è‡ªå·±çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„äº‹ä»¶ï¼š

```
/**
 * è‡ªå·±æœ¬èº«å°±æ˜¯ä¸€ä¸ª watcherï¼Œå¯ä»¥å¾—åˆ°é€šçŸ¥
 * AutoCloseable å®ç°è‡ªåŠ¨å…³é—­ï¼Œèµ„æºä¸ä½¿ç”¨çš„æ—¶å€™
 */
@Slf4j
public class ZkLock implements AutoCloseable, Watcher {

    private ZooKeeper zooKeeper;

    /**
     * è®°å½•å½“å‰é”çš„åå­—
     */
    private String znode;

    public ZkLock() throws IOException {
        this.zooKeeper = new ZooKeeper("localhost:2181",
                10000,this);
    }

    public boolean getLock(String businessCode) {
        try {
            //åˆ›å»ºä¸šåŠ¡ æ ¹èŠ‚ç‚¹
            Stat stat = zooKeeper.exists("/" + businessCode, false);
            if (stat==null){
                zooKeeper.create("/" + businessCode,businessCode.getBytes(),
                        ZooDefs.Ids.OPEN_ACL_UNSAFE,
                        CreateMode.PERSISTENT);
            }

            //åˆ›å»ºç¬æ—¶æœ‰åºèŠ‚ç‚¹  /order/order_00000001
            znode = zooKeeper.create("/" + businessCode + "/" + businessCode + "_", businessCode.getBytes(),
                    ZooDefs.Ids.OPEN_ACL_UNSAFE,
                    CreateMode.EPHEMERAL_SEQUENTIAL);

            //è·å–ä¸šåŠ¡èŠ‚ç‚¹ä¸‹ æ‰€æœ‰çš„å­èŠ‚ç‚¹
            List<String> childrenNodes = zooKeeper.getChildren("/" + businessCode, false);
            //è·å–åºå·æœ€å°çš„ï¼ˆç¬¬ä¸€ä¸ªï¼‰å­èŠ‚ç‚¹
            Collections.sort(childrenNodes);
            String firstNode = childrenNodes.get(0);
            //å¦‚æœåˆ›å»ºçš„èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œåˆ™è·å¾—é”
            if (znode.endsWith(firstNode)){
                return true;
            }
            //å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œåˆ™ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
            String lastNode = firstNode;
            for (String node:childrenNodes){
                if (znode.endsWith(node)){
                    zooKeeper.exists("/"+businessCode+"/"+lastNode,true);
                    break;
                }else {
                    lastNode = node;
                }
            }
            synchronized (this){
                wait();
            }
            return true;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public void close() throws Exception {
        zooKeeper.delete(znode,-1);
        zooKeeper.close();
        log.info("æˆ‘å·²ç»é‡Šæ”¾äº†é”ï¼");
    }

    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDeleted){
            synchronized (this){
                notify();
            }
        }
    }
}
```

**3.5 zookeeper curator**

åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œä¸å»ºè®®å»è‡ªå·± â€œé‡å¤é€ è½®å­â€ï¼Œè€Œå»ºè®®ç›´æ¥ä½¿ç”¨ Curator å®¢æˆ·ç«¯ä¸­çš„å„ç§å®˜æ–¹å®ç°çš„åˆ†å¸ƒå¼é”ï¼Œä¾‹å¦‚å…¶ä¸­çš„ InterProcessMutex å¯é‡å…¥é”ã€‚

```
<dependency>
  <groupId>org.apache.curator</groupId>
  <artifactId>curator-recipes</artifactId>
  <version>4.2.0</version>
  <exclusions>
    <exclusion>
      <artifactId>slf4j-api</artifactId>
      <groupId>org.slf4j</groupId>
    </exclusion>
  </exclusions>
</dependency>
```

```
@Bean(initMethod="start",destroyMethod = "close")
public CuratorFramework getCuratorFramework() {
    RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
    CuratorFramework client = CuratorFrameworkFactory.
        newClient("localhost:2181", retryPolicy);
    return client;
}
```

æ¡†æ¶å·²ç»å®ç°äº†åˆ†å¸ƒå¼é”ã€‚zk çš„ Java å®¢æˆ·ç«¯å‡çº§ç‰ˆã€‚ä½¿ç”¨çš„æ—¶å€™ç›´æ¥æŒ‡å®šé‡è¯•çš„ç­–ç•¥å°±å¯ä»¥ã€‚

å®˜ç½‘ä¸­åˆ†å¸ƒå¼é”çš„å®ç°æ˜¯åœ¨ curator-recipes ä¾èµ–ä¸­ï¼Œä¸è¦å¼•ç”¨é”™äº†ã€‚

```
@Autowired
private CuratorFramework client;

@Test
public void testCuratorLock(){
    InterProcessMutex lock = new InterProcessMutex(client, "/order");
    try {
        if ( lock.acquire(30, TimeUnit.SECONDS) ) {
            try  {
                log.info("æˆ‘è·å¾—äº†é”ï¼ï¼ï¼");
            }
            finally  {
                lock.release();
            }
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    client.close();
}
```

**3.6 Redission**

é‡æ–°å®ç°äº† Java å¹¶å‘åŒ…ä¸‹å¤„ç†å¹¶å‘çš„ç±»ï¼Œè®©å…¶å¯ä»¥è·¨ JVM ä½¿ç”¨ï¼Œä¾‹å¦‚ CHM ç­‰ã€‚

3.6.1 é SpringBoot é¡¹ç›®å¼•å…¥

https://redisson.org/

å¼•å…¥ Redisson çš„ä¾èµ–ï¼Œç„¶åé…ç½®å¯¹åº”çš„ XML å³å¯ï¼š

```
<dependency>
  <groupId>org.redisson</groupId>
  <artifactId>redisson</artifactId>
  <version>3.11.2</version>
  <exclusions>
    <exclusion>
      <artifactId>slf4j-api</artifactId>
      <groupId>org.slf4j</groupId>
    </exclusion>
  </exclusions>
</dependency>
```

ç¼–å†™ç›¸åº”çš„ redisson.xml

```
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:redisson="http://redisson.org/schema/redisson"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://redisson.org/schema/redisson
       http://redisson.org/schema/redisson/redisson.xsd
">

    <redisson:client>
        <redisson:single-server address="redis://127.0.0.1:6379"/>
    </redisson:client>
</beans>
```

é…ç½®å¯¹åº” @ImportResource("classpath*:redisson.xml") èµ„æºæ–‡ä»¶ã€‚

3.6.2Â SpringBoot é¡¹ç›®å¼•å…¥

æˆ–è€…ç›´æ¥ä½¿ç”¨ springBoot çš„ starter å³å¯ã€‚

https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter

```
<dependency>
  <groupId>org.redisson</groupId>
  <artifactId>redisson-spring-boot-starter</artifactId>
  <version>3.19.1</version>
</dependency>
```

ä¿®æ”¹ application.properties å³å¯ï¼š#spring.redis.host=

3.6.3 è®¾ç½®é…ç½®ç±»

```
@Bean
public RedissonClient getRedissonClient() {
    Config config = new Config();
    config.useSingleServer().setAddress("redis://127.0.0.1:6379");
    return Redisson.create(config);
}
```

3.6.4 ä½¿ç”¨

```
@Test
public void testRedissonLock() {
    RLock rLock = redisson.getLock("order");
    try {
        rLock.lock(30, TimeUnit.SECONDS);
        log.info("æˆ‘è·å¾—äº†é”ï¼ï¼ï¼");
        Thread.sleep(10000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }finally {
        log.info("æˆ‘é‡Šæ”¾äº†é”ï¼ï¼");
        rLock.unlock();
    }
}
```

**3.7 Etcd**

å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼Œæ™®é€šé¡¹ç›®ä¸ä¼šä¸ºäº†ä¸€æŠŠé”å¼•å…¥ etcdï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ï¼š

https://time.geekbang.org/column/article/350285

å››ã€å¸¸è§åˆ†å¸ƒå¼é”çš„åŸç†

**4.1 Redisson**

Redis 2.6 ä¹‹åæ‰å¯ä»¥æ‰§è¡Œ lua è„šæœ¬ï¼Œæ¯”èµ·ç®¡é“è€Œè¨€ï¼Œè¿™æ˜¯åŸå­æ€§çš„ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªå•†å“å‡åº“å­˜çš„åŸå­æ“ä½œï¼š

```
//luaè„šæœ¬å‘½ä»¤æ‰§è¡Œæ–¹å¼ï¼šredis-cli --eval /tmp/test.lua , 10
jedis.set("product_stock_10016", "15");  
//åˆå§‹åŒ–å•†å“10016çš„åº“å­˜
String script = " local count = redis.call('get', KEYS[1]) " +
        " local a = tonumber(count) " +
        " local b = tonumber(ARGV[1]) " +
        " if a >= b then " +
        "   redis.call('set', KEYS[1], a-b) " +
        "   return 1 " +
        " end " +
        " return 0 ";
Object obj = jedis.eval(script, Arrays.asList("product_stock_10016"), 
                        Arrays.asList("10"));
System.out.println(obj);
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIK5fDhibQZSbdC90oYRQBibGWHUgtFWxjvgzMKTz8GdHUKZYwibDIFibQJg/640?wx_fmt=jpeg)

4.1.1 å°è¯•åŠ é”çš„é€»è¾‘

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIxEclSwQSxY3v1R0MZGJkU8S1IicFGaOktkicrFbSVZVfesGFbopGwUwg/640?wx_fmt=png)

ä¸Šé¢çš„ org.redisson.RedissonLock#lock() é€šè¿‡è°ƒç”¨è‡ªå·±æ–¹æ³•å†…éƒ¨çš„ lock æ–¹æ³•çš„ org.redisson.RedissonLock#tryAcquire æ–¹æ³•ã€‚ä¹‹åè°ƒç”¨ org.redisson.RedissonLock#tryAcquireAsyncï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIb2eRVMve4nNZYfhbts78DKwoZKRZpmaITuibEEV9tCr0NV3ibH20v4ZQ/640?wx_fmt=png)

é¦–å…ˆè°ƒç”¨å†…éƒ¨çš„ org.redisson.RedissonLock#tryLockInnerAsyncï¼šè®¾ç½®å¯¹åº”çš„åˆ†å¸ƒå¼é”

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHI4P7sbX3Sib5EdGFpicLGzBDDmLAWeayquViboibCia2ydzumA4sdW6p1NCw/640?wx_fmt=png)

åˆ°è¿™é‡Œè·å–é”çš„é€»è¾‘å°±ç»“æŸäº†ï¼Œå¦‚æœè¿™é‡Œæ²¡æœ‰è·å–åˆ°ï¼Œåœ¨ Future çš„å›è°ƒé‡Œé¢å°±ä¼šç›´æ¥ returnï¼Œä¼šåœ¨å¤–å±‚æœ‰ä¸€ä¸ª while true çš„å¾ªç¯ï¼Œè®¢é˜…é‡Šæ”¾é”çš„æ¶ˆæ¯å‡†å¤‡è¢«å”¤é†’ã€‚å¦‚æœè¯´åŠ é”æˆåŠŸï¼Œå°±å¼€å§‹æ‰§è¡Œé”ç»­å‘½é€»è¾‘ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIKHib6voBcIXa2BIibgOYRlsricJ6RgC7KWVibQiaEoXxQxxCvwffTFaIdSg/640?wx_fmt=png)

4.1.2Â é”ç»­å‘½é€»è¾‘

lua è„šæœ¬æœ€åæ˜¯ä»¥æ¯«ç§’ä¸ºå•ä½è¿”å› key çš„å‰©ä½™è¿‡æœŸæ—¶é—´ã€‚æˆåŠŸåŠ é”ä¹‹å org.redisson.RedissonLock#scheduleExpirationRenewal ä¸­å°†ä¼šè°ƒç”¨ org.redisson.RedissonLock#renewExpirationï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨å°±æœ‰é”ç»­å‘½çš„é€»è¾‘ï¼Œæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œç­‰ 10s æ‰§è¡Œã€‚

æ‰§è¡Œçš„æ—¶å€™å°è¯•æ‰§è¡Œçš„ç»­å‘½é€»è¾‘ä½¿ç”¨çš„æ˜¯ Lua è„šæœ¬ï¼Œå½“å‰çš„é”æœ‰å€¼ï¼Œå°±ç»­å‘½ï¼Œæ²¡æœ‰å°±ç›´æ¥è¿”å› 0ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIpOXU0zWb8W3suHJOVKmcHMrbF1Nd4GCsStCApvb8JqgXCWbEvgyKqQ/640?wx_fmt=png)

è¿”å› 0 ä¹‹åå¤–å±‚ä¼šåˆ¤æ–­ï¼Œå»¶æ—¶æˆåŠŸå°±ä¼šå†æ¬¡è°ƒç”¨è‡ªå·±ï¼Œå¦åˆ™å»¶æ—¶è°ƒç”¨ç»“æŸï¼Œä¸å†ä¸ºå½“å‰çš„é”ç»­å‘½ã€‚æ‰€ä»¥è¿™é‡Œçš„ç»­å‘½ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„å®šæ—¶ï¼Œè€Œæ˜¯å¾ªç¯è°ƒç”¨è‡ªå·±çš„å»¶æ—¶ä»»åŠ¡ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIMDtlMI9doSku8UyV9CJlicr6R7UHFqoe0JgtGvcDaIjia2mftyUt2sCw/640?wx_fmt=png)

4.1.3Â å¾ªç¯é—´éš”æŠ¢é”æœºåˆ¶

å¦‚æœä¸€å¼€å§‹å°±åŠ é”æˆåŠŸå°±ç›´æ¥è¿”å›ã€‚

å¦‚æœä¸€å¼€å§‹åŠ é”å¤±è´¥ï¼Œæ²¡æŠ¢åˆ°é”çš„çº¿ç¨‹å°±ä¼šåœ¨ while å¾ªç¯ä¸­å°è¯•åŠ é”ï¼ŒåŠ é”æˆåŠŸå°±ç»“æŸå¾ªç¯ï¼Œå¦åˆ™ç­‰å¾…å½“å‰é”çš„è¶…æ—¶æ—¶é—´ä¹‹åå†æ¬¡å°è¯•åŠ é”ã€‚æ‰€ä»¥å®ç°é€»è¾‘é»˜è®¤æ˜¯éå…¬å¹³é”ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIyhL7NrQk1QltsaZ5RTwHIv57YRpstdo3mjHEQNZpDvzxXtd5iaxib90A/640?wx_fmt=png)

é‡Œé¢æœ‰ä¸€ä¸ª subscribe çš„é€»è¾‘ï¼Œä¼šç›‘å¬å¯¹åº”åŠ é”çš„ keyï¼Œå½“é”é‡Šæ”¾ä¹‹å publish å¯¹åº”çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶å¦‚æœæ²¡æœ‰åˆ°è¾¾å¯¹åº”çš„é”çš„è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿä¼šå°è¯•è·å–é”ï¼Œé¿å…æ—¶é—´æµªè´¹ã€‚

4.1.4Â é‡Šæ”¾é”å’Œå”¤é†’å…¶ä»–çº¿ç¨‹çš„é€»è¾‘

å‰é¢æ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹ä¼šç›‘å¬å¯¹åº”çš„ queueï¼Œåé¢æŠ¢åˆ°é”çš„çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ä¼šå‘é€ä¸€ä¸ªæ¶ˆæ¯ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIBv6QVEe1SFo9rVYfXt8hQudqB6yapdKOL7towYHLOXL6yAJvHQPotg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIicTlagNyO1vos5DoC0pKbSxnTov0wKb51n1rXVpMQvdZCDdh7yfbusA/640?wx_fmt=png)

è®¢é˜…çš„æ—¶å€™æŒ‡å®šæ”¶åˆ°æ¶ˆæ¯æ—¶å€™çš„é€»è¾‘ï¼šä¼šå”¤é†’é˜»å¡ä¹‹åæ‰§è¡Œ while å¾ªç¯

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIrD8OAVQPPa7H9aL9RGqF8sq8qRsZJmLkX7OuPIKBicQRQy5iaQ9buM3w/640?wx_fmt=png)

4.1.5Â é‡å…¥é”çš„é€»è¾‘

å­˜åœ¨å¯¹åº”çš„é”ï¼Œå°±å¯¹å¯¹åº”çš„ hash ç»“æ„çš„ value ç›´æ¥ + 1ï¼Œå’Œ Java é‡å…¥é”çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHI9HCNOZvPotme9TH5iby8BUufAukFb2bTCfo16elSqiao3wgo1ibrA3AicQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIvMcwX7Orib4Va8kwicePapQKeCqS34KicJkrrHyJgXKT4Gx5lTBia8Av4Q/640?wx_fmt=png)

**4.2 RedLock è§£å†³éå•ä½“é¡¹ç›®çš„ Redis ä¸»ä»æ¶æ„çš„é”å¤±æ•ˆ**

https://redis.io/docs/manual/patterns/distributed-locks/

æŸ¥çœ‹ Redis å®˜æ–¹æ–‡æ¡£ï¼Œå¯¹äºå•èŠ‚ç‚¹çš„ Redis ï¼Œä½¿ç”¨ setnx å’Œ lua del åˆ é™¤åˆ†å¸ƒå¼é”æ˜¯è¶³å¤Ÿçš„ï¼Œä½†æ˜¯ä¸»ä»æ¶æ„çš„åœºæ™¯ä¸‹ï¼šé”å…ˆåŠ åœ¨ä¸€ä¸ª master èŠ‚ç‚¹ä¸Šï¼Œé»˜è®¤æ˜¯å¼‚æ­¥åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œæ­¤æ—¶ master æŒ‚äº†ä¼šé€‰æ‹© slave ä¸º masterï¼Œæ­¤æ—¶åˆå¯ä»¥åŠ é”ï¼Œå°±ä¼šå¯¼è‡´è¶…å–ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨ zookeeper æ¥å®ç°çš„è¯ï¼Œç”±äº zk æ˜¯ CP çš„ï¼Œæ‰€ä»¥ CP ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ã€‚

**Redis æ–‡æ¡£ä¸­ç»™å‡ºäº† RedLock çš„è§£å†³åŠæ³•ï¼Œä½¿ç”¨ redLock çœŸçš„å¯ä»¥è§£å†³å—ï¼Ÿ**

4.2.1 RedLock åŸç†

åŸºäºå®¢æˆ·ç«¯çš„å®ç°ï¼Œæ˜¯åŸºäºå¤šä¸ªç‹¬ç«‹çš„ Redis Master èŠ‚ç‚¹çš„ä¸€ç§å®ç°ï¼ˆä¸€èˆ¬ä¸º 5ï¼‰ã€‚client ä¾æ¬¡å‘å„ä¸ªèŠ‚ç‚¹ç”³è¯·é”ï¼Œè‹¥èƒ½ä»å¤šæ•°ä¸ªèŠ‚ç‚¹ä¸­ç”³è¯·é”æˆåŠŸå¹¶æ»¡è¶³ä¸€äº›æ¡ä»¶é™åˆ¶ï¼Œé‚£ä¹ˆ client å°±èƒ½è·å–é”æˆåŠŸã€‚å®ƒé€šè¿‡ç‹¬ç«‹çš„ N ä¸ª Master èŠ‚ç‚¹ï¼Œé¿å…äº†ä½¿ç”¨ä¸»å¤‡å¼‚æ­¥å¤åˆ¶åè®®çš„ç¼ºé™·ï¼Œåªè¦å¤šæ•° Redis èŠ‚ç‚¹æ­£å¸¸å°±èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¾è‘—æå‡äº†åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€‚

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHINAnSt5OgaerXYbxsF6ibTiaiamAZTv9ez3Q01dqyQ3u2ogvsIGzEhTbzw/640?wx_fmt=jpeg)

æ³¨æ„å›¾ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯ master èŠ‚ç‚¹ã€‚åŠ é”è¶…è¿‡åŠæ•°æˆåŠŸï¼Œå°±è®¤ä¸ºæ˜¯æˆåŠŸã€‚å…·ä½“æµç¨‹ï¼š

*   è·å–é”
*   è·å–å½“å‰æ—¶é—´ T1ï¼Œä½œä¸ºåç»­çš„è®¡æ—¶ä¾æ®ï¼›
    
*   æŒ‰é¡ºåºåœ°ï¼Œä¾æ¬¡å‘ 5 ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹æ¥å°è¯•è·å–é” SET resource_name my_random_value NX PX 30000ï¼›
    
*   è®¡ç®—è·å–é”æ€»å…±èŠ±äº†å¤šå°‘æ—¶é—´ï¼Œåˆ¤æ–­è·å–é”æˆåŠŸä¸å¦ï¼›
    
*   æ—¶é—´ï¼šT2-T1ï¼›
    
*   å¤šæ•°èŠ‚ç‚¹çš„é”ï¼ˆN/2+1ï¼‰ï¼›
    
*   å½“è·å–é”æˆåŠŸåçš„æœ‰æ•ˆæ—¶é—´ï¼Œè¦ä»åˆå§‹çš„æ—¶é—´å‡å»ç¬¬ä¸‰æ­¥ç®—å‡ºæ¥çš„æ¶ˆè€—æ—¶é—´ï¼›
    
*   å¦‚æœæ²¡èƒ½è·å–é”æˆåŠŸï¼Œå°½å¿«é‡Šæ”¾æ‰é”ã€‚
*   é‡Šæ”¾é”
*   å‘æ‰€æœ‰èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”çš„æ“ä½œï¼Œä¸ç®¡è¿™äº›èŠ‚ç‚¹æœ‰æ²¡æœ‰æˆåŠŸè®¾ç½®è¿‡ã€‚

```
public String redlock() {
    String lockKey = "product_001";
    //è¿™é‡Œéœ€è¦è‡ªå·±å®ä¾‹åŒ–ä¸åŒrediså®ä¾‹çš„redissonå®¢æˆ·ç«¯è¿æ¥ï¼Œè¿™é‡Œåªæ˜¯ä¼ªä»£ç ç”¨ä¸€ä¸ªredissonå®¢æˆ·ç«¯ç®€åŒ–äº†
    RLock lock1 = redisson.getLock(lockKey);
    RLock lock2 = redisson.getLock(lockKey);
    RLock lock3 = redisson.getLock(lockKey);

    /**
     * æ ¹æ®å¤šä¸ª RLock å¯¹è±¡æ„å»º RedissonRedLock ï¼ˆæœ€æ ¸å¿ƒçš„å·®åˆ«å°±åœ¨è¿™é‡Œï¼‰
     */
    RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3);
    try {
        /**
         * waitTimeout å°è¯•è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥
         * leaseTime   é”çš„æŒæœ‰æ—¶é—´,è¶…è¿‡è¿™ä¸ªæ—¶é—´é”ä¼šè‡ªåŠ¨å¤±æ•ˆï¼ˆå€¼åº”è®¾ç½®ä¸ºå¤§äºä¸šåŠ¡å¤„ç†çš„æ—¶é—´ï¼Œç¡®ä¿åœ¨é”æœ‰æ•ˆæœŸå†…ä¸šåŠ¡èƒ½å¤„ç†å®Œï¼‰
         */
        boolean res = redLock.tryLock(10, 30, TimeUnit.SECONDS);
        if (res) {
            //æˆåŠŸè·å¾—é”ï¼Œåœ¨è¿™é‡Œå¤„ç†ä¸šåŠ¡
        }
    } catch (Exception e) {
        throw new RuntimeException("lock fail");
    } finally {
        //æ— è®ºå¦‚ä½•, æœ€åéƒ½è¦è§£é”
        redLock.unlock();
    }

    return "end";
}
```

ä½†æ˜¯ï¼Œå®ƒçš„å®ç°å»ºç«‹åœ¨ä¸€ä¸ªä¸å®‰å…¨çš„ç³»ç»Ÿæ¨¡å‹ä¸Šçš„ï¼Œå®ƒä¾èµ–ç³»ç»Ÿæ—¶é—´ï¼Œå½“æ—¶é’Ÿå‘ç”Ÿè·³è·ƒæ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°å®‰å…¨æ€§é—®é¢˜ã€‚åˆ†å¸ƒå¼å­˜å‚¨ä¸“å®¶ Martin å¯¹ RedLock çš„åˆ†ææ–‡ç« ï¼ŒRedis ä½œè€…çš„ä¹Ÿä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« è¿›è¡Œäº†åé©³ã€‚

Martin Kleppmannï¼šHow to do distributed locking

https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html

Antirezï¼šIs Redlock safe?

http://antirez.com/news/101

4.2.2 RedLock é—®é¢˜ä¸€ï¼šæŒä¹…åŒ–æœºåˆ¶å¯¼è‡´é‡å¤åŠ é”

å¦‚æœæ˜¯ä¸Šé¢çš„æ¶æ„å›¾ï¼Œä¸€èˆ¬ç”Ÿäº§éƒ½ä¸ä¼šé…ç½® AOF çš„æ¯ä¸€æ¡å‘½ä»¤éƒ½è½ç£ç›˜ï¼Œä¸€èˆ¬ä¼šè®¾ç½®ä¸€äº›é—´éš”æ—¶é—´ï¼Œæ¯”å¦‚ 1sï¼Œå¦‚æœ ABC èŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œæœ‰ä¸€ä¸ªèŠ‚ç‚¹ C æ°å¥½æ˜¯åœ¨ 1s å†…åŠ é”ï¼Œè¿˜æ²¡æœ‰è½ç›˜ï¼Œæ­¤æ—¶æŒ‚äº†ï¼Œå°±ä¼šå¯¼è‡´å…¶ä»–å®¢æˆ·ç«¯é€šè¿‡ CDE åˆä¼šåŠ é”æˆåŠŸã€‚

4.2.3 RedLock é—®é¢˜äºŒï¼šä¸»ä»ä¸‹é‡å¤åŠ é”

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHI6y91yazvt7nt63HibfmpnZ1w98A60YzmD0D4ydHcFUOFFZL8uVQofSA/640?wx_fmt=jpeg)

é™¤éå¤šéƒ¨ç½²ä¸€äº›èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´åŠ é”æ—¶é—´å˜é•¿ï¼Œè¿™æ ·æ¯”è¾ƒä¸‹æ¥æ•ˆæœå°±ä¸å¦‚ zk äº†ã€‚

4.2.4 RedLock é—®é¢˜ä¸‰ï¼šæ—¶é’Ÿè·³è·ƒå¯¼è‡´é‡å¤åŠ é”

C èŠ‚ç‚¹å‘ç”Ÿäº†æ—¶é’Ÿè·³è·ƒï¼Œå¯¼è‡´åŠ ä¸Šçš„é”æ²¡æœ‰åˆ°è¾¾å®é™…çš„è¶…æ—¶æ—¶é—´ï¼Œå°±è¢«è¯¯ä»¥ä¸ºè¶…æ—¶è€Œé‡Šæ”¾ï¼Œæ­¤æ—¶å…¶ä»–å®¢æˆ·ç«¯å°±å¯ä»¥é‡å¤åŠ é”äº†ã€‚

**4.3 Curator**

InterProcessMutex å¯é‡å…¥é”çš„åˆ†æ

![](https://mmbiz.qpic.cn/mmbiz_jpg/OmCbZ5JK30Etocz5XrGvKj5upcCB2XHIU40DoQUBY4yzqsy0UhYNYlkUPTFVaKIaF8BsKjVwnfCp0KdsbaiaObQ/640?wx_fmt=jpeg)

äº”ã€ä¸šåŠ¡ä¸­ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ³¨æ„ç‚¹

è·å–çš„é”è¦è®¾ç½®æœ‰æ•ˆæœŸï¼Œå‡è®¾æˆ‘ä»¬æœªè®¾ç½® key è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œåœ¨ Set key value NX åï¼Œå¦‚æœç¨‹åº crash æˆ–è€…å‘ç”Ÿç½‘ç»œåˆ†åŒºåæ— æ³•ä¸ Redis èŠ‚ç‚¹é€šä¿¡ï¼Œæ¯«æ— ç–‘é—®å…¶ä»– client å°†æ°¸è¿œæ— æ³•è·å¾—é”ï¼Œè¿™å°†å¯¼è‡´æ­»é”ï¼ŒæœåŠ¡å‡ºç°ä¸­æ–­ã€‚

SETNX å’Œ EXPIRE å‘½ä»¤å»è®¾ç½® key å’Œè¿‡æœŸæ—¶é—´ï¼Œè¿™ä¹Ÿæ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºä½ æ— æ³•ä¿è¯ SETNX å’Œ EXPIRE å‘½ä»¤çš„åŸå­æ€§ã€‚

è‡ªå·±ä½¿ç”¨ setnx å®ç° Redis é”çš„æ—¶å€™ï¼Œæ³¨æ„å¹¶å‘æƒ…å†µä¸‹ä¸è¦é‡Šæ”¾æ‰åˆ«äººçš„é”ï¼ˆä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„è¿‡æœŸæ—¶é—´ï¼‰ï¼Œå¯¼è‡´æ¶æ€§å¾ªç¯ã€‚ä¸€èˆ¬ï¼š

1ï¼‰åŠ é”çš„æ—¶å€™éœ€è¦æŒ‡å®š value çš„å†…å®¹æ˜¯å½“å‰è¿›ç¨‹ä¸­çš„å½“å‰çº¿ç¨‹çš„å”¯ä¸€æ ‡è®°ï¼Œä¸è¦ä½¿ç”¨çº¿ç¨‹ ID ä½œä¸ºå½“å‰çº¿ç¨‹çš„é”çš„æ ‡è®°ï¼Œå› ä¸ºä¸åŒå®ä¾‹ä¸Šçš„çº¿ç¨‹ ID å¯èƒ½æ˜¯ä¸€æ ·çš„ã€‚

2ï¼‰é‡Šæ”¾é”çš„é€»è¾‘ä¼šå†™åœ¨ finally ï¼Œé‡Šæ”¾é”æ—¶å€™è¦åˆ¤æ–­é”å¯¹åº”çš„ valueï¼Œè€Œä¸”è¦ä½¿ç”¨ lua è„šæœ¬å®ç°åŸå­ del æ“ä½œã€‚å› ä¸º if é€»è¾‘åˆ¤æ–­å®Œä¹‹åä¹Ÿå¯èƒ½å¤±æ•ˆå¯¼è‡´åˆ é™¤åˆ«äººçš„é”ã€‚  

3ï¼‰é’ˆå¯¹æ‰£å‡åº“å­˜è¿™ä¸ªé€»è¾‘ï¼Œlua è„šæœ¬é‡Œé¢å®ç° Redis æ¯”è¾ƒåº“å­˜ã€æ‰£å‡åº“å­˜æ“ä½œçš„åŸå­æ€§ã€‚é€šè¿‡åˆ¤æ–­ Redis Decr å‘½ä»¤çš„è¿”å›å€¼å³å¯ã€‚æ­¤å‘½ä»¤ä¼šè¿”å›æ‰£å‡åçš„æœ€æ–°åº“å­˜ï¼Œè‹¥å°äº 0 åˆ™è¡¨ç¤ºè¶…å–ã€‚  

**5.1 è‡ªå·±å®ç°åˆ†å¸ƒå¼é”çš„å‘**

setnx ä¸å…³å¿ƒé”çš„é¡ºåºå¯¼è‡´åˆ é™¤åˆ«äººçš„é”

é”å¤±æ•ˆä¹‹åï¼Œåˆ«äººåŠ é”æˆåŠŸï¼Œè‡ªå·±æŠŠåˆ«äººçš„é”åˆ äº†ã€‚

æˆ‘ä»¬æ— æ³•é¢„ä¼°ç¨‹åºæ‰§è¡Œéœ€è¦çš„é”çš„æ—¶é—´ã€‚

```
public String deductStock() {
    String lockKey = "lock:product_101";
    Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, "deltaqin");
    stringRedisTemplate.expire(lockKey, 10, TimeUnit.SECONDS);

    try {
        int stock = Integer.parseInt(stringRedisTemplate.opsForValue().get("stock")); // jedis.get("stock")
        if (stock > 0) {
            int realStock = stock - 1;
            stringRedisTemplate.opsForValue().set("stock", realStock + ""); // jedis.set(key,value)
            System.out.println("æ‰£å‡æˆåŠŸï¼Œå‰©ä½™åº“å­˜:" + realStock);
        } else {
            System.out.println("æ‰£å‡å¤±è´¥ï¼Œåº“å­˜ä¸è¶³");
        }
    } finally {
        stringRedisTemplate.delete(lockKey);
    }

    return "end";
}
```

setnx å…³å¿ƒé”çš„é¡ºåºè¿˜æ˜¯åˆ é™¤äº†åˆ«äººçš„é”

å¹¶å‘ä¼šå¡åœ¨å„ç§åœ°æ–¹ï¼Œå¡ä½çš„æ—¶å€™è¿‡æœŸäº†ï¼Œå°±ä¼šåˆ æ‰åˆ«äººåŠ çš„é”ï¼š

é”™è¯¯çš„åŸå› è¿˜æ˜¯å› ä¸ºè§£é”çš„é€»è¾‘ä¸æ˜¯åŸå­æ€§çš„ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒ Redisson çš„è§£é”é€»è¾‘ä½¿ç”¨ lua è„šæœ¬å®ç°ã€‚

```
public String deductStock() {
    String lockKey = "lock:product_101";
    String clientId = UUID.randomUUID().toString();
    Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, clientId, 30, TimeUnit.SECONDS); //jedis.setnx(k,v)
    if (!result) {
        return "error_code";
    }
    try {
        int stock = Integer.parseInt(stringRedisTemplate.opsForValue().get("stock")); // jedis.get("stock")
        if (stock > 0) {
            int realStock = stock - 1;
            stringRedisTemplate.opsForValue().set("stock", realStock + ""); // jedis.set(key,value)
            System.out.println("æ‰£å‡æˆåŠŸï¼Œå‰©ä½™åº“å­˜:" + realStock);
        } else {
            System.out.println("æ‰£å‡å¤±è´¥ï¼Œåº“å­˜ä¸è¶³");
        }
    } finally {
        if (clientId.equals(stringRedisTemplate.opsForValue().get(lockKey))) {
            // å¡åœ¨è¿™é‡Œï¼Œé”è¿‡æœŸäº†ï¼Œå…¶ä»–çº¿ç¨‹åˆå¯ä»¥åŠ é”ï¼Œæ­¤æ—¶åˆæŠŠå…¶ä»–çº¿ç¨‹æ–°åŠ çš„é”åˆ æ‰äº†
            stringRedisTemplate.delete(lockKey);
        }
    }
    return "end";
}
```

è§£å†³åŠæ³•

è¿™ç§é—®é¢˜è§£å†³çš„åŠæ³•å°±æ˜¯ä½¿ç”¨é”ç»­å‘½ï¼Œæ¯”å¦‚ä½¿ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡é—´éš”å°äºé”çš„è¶…æ—¶æ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ç»™é”ç»­å‘½ï¼Œé™¤éçº¿ç¨‹è‡ªå·±ä¸»åŠ¨åˆ é™¤ã€‚è¿™ä¹Ÿæ˜¯ Redisson çš„å®ç°æ€è·¯ã€‚

**5.2 é”ä¼˜åŒ–ï¼šåˆ†æ®µåŠ é”é€»è¾‘**

é’ˆå¯¹ä¸€ä¸ªå•†å“ï¼Œè¦å¼€å¯ç§’æ€çš„æ—¶å€™ï¼Œä¼šå°†å•†å“çš„åº“å­˜é¢„å…ˆåŠ è½½åˆ° Redis ç¼“å­˜ä¸­ï¼Œæ¯”å¦‚æœ‰ 100 ä¸ªåº“å­˜ï¼Œæ­¤æ—¶å¯ä»¥åˆ†ä¸º 5 ä¸ª keyï¼Œæ¯ä¸€ä¸ª key æœ‰ 20 ä¸ªåº“å­˜ã€‚å¯ä»¥æŠŠåˆ†å¸ƒå¼é”çš„æ€§èƒ½æå‡ 5 å€ã€‚

ä¾‹å¦‚ï¼š

*   product_10111_stock = 100
*   product_10111_stock1 = 20
    
*   product_10111_stock2 = 20
    
*   product_10111_stock3 = 20
    
*   product_10111_stock4 = 20
    
*   product_10111_stock5 = 20

è¯·æ±‚æ¥äº†å¯ä»¥éšæœºå¯ä»¥è½®è¯¢ï¼Œæ‰£å‡å®Œä¹‹åå°±æ ‡è®°ä¸è¦ä¸‹æ¬¡å†åˆ†é…åˆ°è¿™ä¸ªåº“å­˜ã€‚

å…­ã€åˆ†å¸ƒå¼é”çš„çœŸç›¸ä¸é€‰æ‹©

**6.1 åˆ†å¸ƒå¼é”çš„çœŸç›¸**

éœ€è¦æ»¡è¶³çš„å‡ ä¸ªç‰¹æ€§

*   äº’æ–¥ï¼šä¸åŒçº¿ç¨‹ã€è¿›ç¨‹äº’æ–¥ã€‚
    
*   è¶…æ—¶æœºåˆ¶ï¼šä¸´ç•ŒåŒºä»£ç è€—æ—¶å¯¼è‡´ï¼Œç½‘ç»œåŸå› å¯¼è‡´ã€‚å¯ä»¥ä½¿ç”¨é¢å¤–çš„çº¿ç¨‹ç»­å‘½ä¿è¯ã€‚
    
*   å®Œå¤‡çš„é”æ¥å£ï¼šé˜»å¡çš„å’Œéé˜»å¡çš„æ¥å£éƒ½è¦æœ‰ï¼Œlock å’Œ tryLockã€‚
    
*   å¯é‡å…¥æ€§ï¼šå½“å‰è¯·æ±‚çš„èŠ‚ç‚¹ + çº¿ç¨‹å”¯ä¸€æ ‡è¯†ã€‚
    
*   å…¬å¹³æ€§ï¼šé”å”¤é†’æ—¶å€™ï¼ŒæŒ‰ç…§é¡ºåºå”¤é†’ã€‚
    
*   æ­£ç¡®æ€§ï¼šè¿›ç¨‹å†…çš„é”ä¸ä¼šå› ä¸ºæŠ¥é”™æ­»é”ï¼Œå› ä¸ºå´©æºƒçš„æ—¶å€™æ•´ä¸ªè¿›ç¨‹éƒ½ä¼šç»“æŸã€‚ä½†æ˜¯å¤šå®ä¾‹éƒ¨ç½²æ—¶æ­»é”å°±å¾ˆå®¹æ˜“å‘ç”Ÿï¼Œå¦‚æœç²—æš´ä½¿ç”¨è¶…æ—¶æœºåˆ¶è§£å†³æ­»é”é—®é¢˜ï¼Œå°±é»˜è®¤äº†ä¸‹é¢è¿™ä¸ªå‡è®¾ï¼š
*   é”çš„è¶…æ—¶æ—¶é—´ >> è·å–é”çš„æ—¶å»¶ + æ‰§è¡Œä¸´ç•ŒåŒºä»£ç çš„æ—¶é—´ + å„ç§è¿›ç¨‹çš„æš‚åœï¼ˆæ¯”å¦‚ GCï¼‰
    
*   ä½†ä¸Šè¿°å‡è®¾å…¶å®æ— æ³•ä¿è¯çš„ã€‚

**å°†åˆ†å¸ƒå¼é”å®šä½ä¸ºï¼Œå¯ä»¥å®¹å¿éå¸¸å°æ¦‚ç‡äº’æ–¥è¯­ä¹‰å¤±æ•ˆåœºæ™¯ä¸‹çš„é”æœåŠ¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼é”æœåŠ¡ï¼Œå®ƒçš„æ­£ç¡®æ€§è¦æ±‚è¶Šé«˜ï¼Œæ€§èƒ½å¯èƒ½å°±ä¼šè¶Šä½ã€‚**

**6.2 åˆ†å¸ƒå¼é”çš„é€‰æ‹©**

*   æ•°æ®åº“ï¼šdb æ“ä½œæ€§èƒ½è¾ƒå·®ï¼Œå¹¶ä¸”æœ‰é”è¡¨çš„é£é™©ï¼Œä¸€èˆ¬ä¸è€ƒè™‘ã€‚
*   ä¼˜ç‚¹ï¼šå®ç°ç®€å•ã€æ˜“äºç†è§£
    
*   ç¼ºç‚¹ï¼šå¯¹æ•°æ®åº“å‹åŠ›å¤§  
*   Redisï¼šé€‚ç”¨äºå¹¶å‘é‡å¾ˆå¤§ã€æ€§èƒ½è¦æ±‚å¾ˆé«˜è€Œå¯é æ€§é—®é¢˜å¯ä»¥é€šè¿‡å…¶ä»–æ–¹æ¡ˆå»å¼¥è¡¥çš„åœºæ™¯ã€‚
*   ä¼˜ç‚¹ï¼šæ˜“äºç†è§£
    
*   ç¼ºç‚¹ï¼šè‡ªå·±å®ç°ã€ä¸æ”¯æŒé˜»å¡
    
*   Redissonï¼šç›¸å¯¹äº Jedis å…¶å®æ›´å¤šç”¨åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ã€‚
*   ä¼˜ç‚¹ï¼šæä¾›é”çš„æ–¹æ³•ï¼Œå¯é˜»å¡  
*   Zookeeperï¼šé€‚ç”¨äºé«˜å¯é ï¼ˆé«˜å¯ç”¨ï¼‰ï¼Œè€Œå¹¶å‘é‡ä¸æ˜¯å¤ªé«˜çš„åœºæ™¯ã€‚
*   ä¼˜ç‚¹ï¼šæ”¯æŒé˜»å¡
    
*   ç¼ºç‚¹ï¼šéœ€ç†è§£ Zookeeperã€ç¨‹åºå¤æ‚  
*   Curator
*   ä¼˜ç‚¹ï¼šæä¾›é”çš„æ–¹æ³•
    
*   ç¼ºç‚¹ï¼šZookeeperï¼Œå¼ºä¸€è‡´ï¼Œæ…¢  
*   Etcdï¼šå®‰å…¨å’Œå¯é æ€§ä¸Šæœ‰ä¿è¯ï¼Œä½†æ˜¯æ¯”è¾ƒé‡ã€‚

ä¸æ¨èè‡ªå·±ç¼–å†™çš„åˆ†å¸ƒå¼é”ï¼Œæ¨èä½¿ç”¨ Redisson å’Œ Curator å®ç°çš„åˆ†å¸ƒå¼é”ã€‚

**æ¬¢è¿åŠ å…¥ã€é˜¿é‡Œäº‘å¼€å‘è€…å…¬ä¼—å·ã€‘è¯»è€…ç¾¤**

è¿™æ˜¯ä¸€ä¸ªä¸“é—¨é¢å‘ â€œé˜¿é‡Œäº‘å¼€å‘è€…â€ å…¬ä¼—å·çš„è¯»è€…äº¤æµç©ºé—´

ğŸ’¡ åœ¨è¿™é‡Œä½ å¯ä»¥æ¢è®¨æŠ€æœ¯å’Œå®è·µï¼Œæˆ‘ä»¬ä¹Ÿä¼šå®šæœŸå‘å¸ƒç¾¤ç¦åˆ©å’Œæ´»åŠ¨ï½

æ¬¢è¿æ‰«ç æˆ–è€…æ·»åŠ å¾®ä¿¡ï¼šargentinaliu åŠ å…¥æˆ‘ä»¬ğŸ‘‡

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z6bicxIx5naJX9eC1Dg9wBvRXkOHXWvaWFscA4jvicTvMWRZAXNqDCNZfLuumg34LDUAibjh4VEaNhEvsqDMokC0A/640?wx_fmt=jpeg&from=appmsg)