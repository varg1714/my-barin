---
source: https://mp.weixin.qq.com/s/JPxRFC3nICMoeDQyLrSFsA
create: 2025-11-11 22:23
read: true
knowledge: true
knowledge-date: 2025-11-12
tags:
  - 系统架构
summary: "[[聊天系统群消息确认机制]]"
---
《架构师之路：架构设计中的 100 个知识点》

111. 群离线消息架构

  

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzpiaIafjicicD7e4XsV3jP4AnicADGEahibeG2MuvcrhjxIqfNqyED7sA1LibFibImLvESoP0ibEKlhcJicAQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)

继续回答星球提问：

1. 群离线消息是推还是拉？

2. 几万条群离线消息，怎么保证不丢失？

画外音：欢迎大家加入星球提问（免费）。  

**群离线消息，是推还是拉？**

关于写扩散、读扩散的问题，之前专门撰文写过，今天重点说说设计的思考过程。

**假如群离线是推，流程应该如何？会遇到什么问题？**  

先看看群离线消息的核心数据结构。

**群成员表**：

t_group_users(group_id, user_id)

_画外音：用来描述一个群里有多少成员。_

**群离线消息表**：

t_offine_msgs(user_id, group_id, sender_id,time, msg_id, msg_detail)

_画外音：用来描述一个群成员的离线消息。_ 

**推，写扩散，存储群离线消息的过程如何？**

1. 先从群成员表中，获取群里有多少个用户；

2. 从某个服务中，获取这些用户有多少个不在线；

3. 将群消息，插入到这些用户的群离线消息表；

_画外音：如果要支持消息漫游，则可以省略步骤二。_

**此时，用户拉取离线消息的过程如何？**

1. 用户登录，向 server 拉取离线消息；

2. server 返回并删除离线消息；

**离线消息推，存在什么问题？**

对于同一份群消息的内容，多个离线用户要存储很多份。假设群中有 200 个用户离线，离线消息则冗余了 200 份，这极大的增加了数据库的存储压力。

**如何优化，减少消息冗余量？**

为了减少离线消息的冗余度，增加一个群消息表，用来存储所有群消息的内容，离线消息表只存储用户的群离线消息 msg_id，就能大大的降低数据库的冗余存储量。

**群消息表**：

t_group_msgs(group_id, sender_id, time, msg_id, msg_detail)

_画外音：用来存储一个群中所有的消息内容。_

**群离线消息表**，需要进行优化：

t_offine_msgs(user_id, group_id, msg_id)

_画外音：优化后只存储 msg_id。_

这样优化后，**群消息的发送和存储**要做一些升级：

1. 每次**发送群消息**之前，先存储群消息的内容；

2. 每次**存储离线消息**时，只存储 msg_id，而不用为每个用户存储 msg_detail；

相应的，**拉取离线消息**也要做对应的升级：

1. 先拉取所有的离线消息 msg_id；

2. 再根据 msg_id 拉取 msg_detail；

3. 删除时，只删除自己的离线 msg_id，而不删除 msg_detail；

_画外音：毕竟 msg_detail 只存储了一份，不能随便删。_  

**上述过程，能保证离线消息的可达性么？**

不能。

例如：server 返回客户端离线消息之后，删除了离线消息，但客户端没有展现就崩溃了，离线消息就会丢失。

**如何解决离线消息可达性呢？**

很容易想到，通过 ACK 机制，server 返回离线消息之后，不能立刻删除离线消息，而必须等客户端 ACK，才能删除。  

此时，离线消息拉取升级为：

1. 用户登录，向 server 拉取离线消息；

2. server 返回离线消息；

3. 客户端确认收到了离线消息；

4. server 再删除离线消息；

_画外音：增加了 3 和 4 两个步骤。_

还有一个问题，一次有几十个群，每个群有几千条离线消息，共计**几万条群离线消息，消息量过大怎么办？**

当然不能一次性拉取，可以：

1. 分群拉取；

2. 每个群分页拉取；

3. 拉取一页，删除一页，拉取下一页，删除下一页...

**如果拉取了消息，却没来得及应用层 ACK，会收到重复的消息么？**

可以在客户端去重，对于重复的 msg_id，对用户不展现，从而不影响用户体验。

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwV8b9As9zQBLCt3cgyYr0Ig8SnIcKqvj6yW8yfM8m3sRlPe1ib4kSBojM7vbFUZbXOjjZIOyicc4xw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=1)

  
如上所示，简单总结就是：

1. 群消息表存储消息实体 msg_detail；

2. 群离线消息表，存每个用户的 msg_id；

3. 分页拉取 + 应用层 ACK，既保证性能，又保证消息可达性；

4. 客户端 msg_id 去重，保证用户体验；  

上面讲的都是 “推” 模式，群离线消息的设计，真正线上应用较多的，是 “拉” 模式。  

**推模式，存在什么问题？**

对于离线的每一条消息，虽然只存储了 msg_id，但是每个用户的每一条离线消息都将在数据库中保存一条记录，**有没有办法减少离线消息的记录数呢？**

对于一个群用户，在 ta 登出后的离线期间内，肯定是所有的群消息都没有收到的，完全不用对所有的每一条离线消息存储一个离线 msg_id，而只需要存储最近一条拉取到的离线消息的 time（或者 msg_id），**下次登录时拉取在那之后的所有群消息即可**，而完全没有必要存储每个人未拉取到的全部离线消息 msg_id。

**拉模式，需要对数据结构进行怎样的升级？**

**群成员表**，增加一个属性：

t_group_users(group_id, user_id, last_ack_msg_id)

_画外音：用来描述一个群里有多少成员，以及每个成员最后一条 ack 的群消息的 msg_id（或者 time）。_

**群消息表**，不变：

t_group_msgs(group_id, sender_id, time, msg_id, msg_detail)

_画外音：还是用来存储一个群中所有的消息内容。_

**群离线消息表**：不再需要。

使用拉模式后，**群消息的发送和存储**也要升级：

1. 在消息 msg_detail 存储到群消息表后，不再需要操作离线消息表（之前需要将 msg_id 插入离线消息表）；

2. 用户收到消息，应用层 ACK 后，将 last_ack_msg_id 更新（之前需要将 msg_id 从离线消息表删除）；

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwV8b9As9zQBLCt3cgyYr0IsU7jol6rdjX1jYwhzCytF3pqibW1Zz0tGUIkcq8bbngJa4nib6NmGvOQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=2)

  
群离线消息的拉取流程也类似：

1. 分页拉取离线消息；

2. ACK 离线消息；

3. 更新 last_ack_msg_id；

**总结**

群消息还是非常有意思的，做个简单总结：  

1. 群离线消息一般采用拉取模式，只存一份，不需要为每个用户存储离线群 msg_id，只需存储一个最近 ack 的群消息 id/time；

2. 为了保证消息可达性，在线消息和离线消息都需要 ACK；

3. 离线消息过多，可以分群拉取、分页拉取等优化；

_画外音：还可按需拉取，登录不拉取，点进群再拉取。_  

4. 如果收到重复消息，需要 msg_id 去重，让用户无感知；

  

群离线消息架构架构设计要点，你学废了吗？

知其然，知其所以然。

**思路比结论更重要。**

== 全文完 ==

有架构合集吗？

合集一：《[流量从 10 万到 10 亿，一定会遇到的 80 个架构问题（8000 字长文）](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651974945&idx=1&sn=58ff54415ddf2dd52d03f47a6790344b&scene=21#wechat_redirect)》

画外音：从理论到实践，15 年架构师生涯的系统性总结。

合集二：《[关于即时通讯架构的一切！](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651975468&idx=1&sn=54ab265bee4998da9a0d32091699cb1d&scene=21#wechat_redirect)》

画外音：职业生涯前 5 年，都在做 IM 架构。

如何提问？

加入免费星球，一起技术交流。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/YrezxckhYOyHicSCibf68mt4pGa2pPmkZNbq2icyf4jsbKwnJJrtlH2sg6nZdy37BC6IaYlNJbu9iahHWBmDrOib6XQ/640?wx_fmt=jpeg&from=appmsg&randomid=g1weg7nk&wxfrom=5&wx_lazy=1&tp=webp#imgIndex=17)

欢迎预约直播：技术人的副业规划（完结篇）！

欢迎预约！