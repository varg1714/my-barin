---
source: https://mp.weixin.qq.com/s/5oVvM25RqD_WPc_XRG6F9Q
create: 2025-11-17 10:58
read: true
knowledge: true
knowledge-date: 2025-11-17
tags:
  - 系统架构
summary: "[[点赞系统设计]]"
---
《架构师之路：架构设计中的 100 个知识点》

113. 高并发计数

  

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzxicrvlOaYJia9EgTqz7xNp5GCaKYibjbicgKgiaY5icXLb5z3GOzRVGMJMnQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)

继续答星球水友提问，**30WQPS 的点赞计数业务，如何设计？**

可以看到，这个**业务的特点**是：

1. 吞吐量超高；

2. 能够接受一定数据不一致；

_画外音：__计数有微小不准确，不是大问题。_

先用最朴素的思想，**只考虑点赞计数，可以怎么做？**

有几点是最容易想到的：

1. 肯定**不能**用数据库扛实时读写流量；

2. redis 天然支持固化，可以用高可用 redis 集群来做固化存储；

3. 也可以用 MySQL 来做固化存储，redis 做缓存，读写操作都落缓存，异步线程定期刷 DB；

4. 架一层计数服务，将计数与业务逻辑解耦；

  

此时 **MySQL 核心数据结构**是：

_t_count(msg_id, praise_count)_

此时 **redis 的 KV 设计**也不难：

_key：__msg_id_

_value：__praise_count_

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzQzRKoEeHqhsN6wBUVEdMZvgeI5iaDXJVwQeic5Ej5TKnm4YjzILt7taw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=1)

似乎很容易就搞定了：

1. 服务可以水平扩展；

2. 数据量增加时，数据库可以水平扩展；

3. 读写量增加时，缓存也可以水平扩展；

  

计数系统的**难点**，还在于业务扩展性问题，以及效率问题。

  

以微博为例：

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzeXGCSzMnBl3ibv6nUx3OA115ypmiaWKYlMNNzDq5mrS4tpmANKpvceIg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=2)

1. 用户微博首页，有多条消息 list<msg_id>，这是一种**扩展**；

2. 同一条消息 msg_id，不止有点赞计数，还有阅读计数，转发计数，评论计数，这也是一种**扩展**；

  

假如用最朴素的方式实现，多条消息多个计数的获取伪代码如下：

_// (1)_ _获取首页所有消息_ _msg_id_

_list<msg_id> = getHomePageMsg(uid);_

_// (2) 对于首页的所有消息要__拉取多个计数_

_for(msg_id in list<msg_id>){_

 _//(3.1) 获取__阅读计数_

 _getReadCount(msg_id);_ 

 _//(3.2) 获取__转发计数_

 _getForwordCount(msg_id);_

 _//(3.3) 获取__评论计数_

 _getCommentCount(msg_id);_

 _//(3.4) 获取__赞计数_

 _getPraiseCount(msg_id);_

_}_

由于同一个 msg_id 多了几种业务计数，redis 的 key 需要带上业务 flag，升级为：

_msg_id:read_

_msg_id:forword_

_msg_id:comment_

_msg_id:praise_

  

用来区分共一个 msg_id 的四种不同业务计数，redis 不能支持 key 的模糊操作，必须访问四次 reids。

  

假设首页有 100 条消息，**这个方案**总结为：

1. for 循环每一条消息，100 条消息 100 次；

2. 每条消息 4 次 RPC 获取计数接口调用；

3. 每次调用服务要访问 reids，拼装 key 获取 count；

_画外音：这种方案的扩展性和效率是非常低的。_

**那如何进行优化呢？**

首先看下**数据库层面元数据扩展**，常见的扩展方式是，增加列，记录更多的业务计数。

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzHmIYTicXlOh8XumOKrVGP8DQPwKl6LAKBSc9KATrqNbvQ7zDTzV66FQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=3)

如上图所示，由一列点赞计数，扩充为四列阅读、转发、评论、点赞计数。

增加列这种业务计数扩展方式的**缺点**是：每次要扩充业务计数时，总是需要修改表结构，增加列，很烦。

  

**有没有不需要变更表结构的扩展方式呢？**

行扩展是一种扩展性更好的方式。

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzJbpOicvbeUIQkQXX5icsstX65bmhes0bFT3mH4PibRJica28p4LXoVXRSg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=4)

表结构固化为：

_t_count(msg_id, count_key, count_value)_

当要扩充业务计数时，增加一行就行，不需要修改表结构。

_画外音：__很多配置业务，会使用这种方案，方便增加配置。_

增加行这种业务计数扩展方式的**缺点**是：表数据行数会增加，但这不是主要矛盾，数据库水平扩展能很轻松解决数据量大的问题。

  

接下来看下 **redis 批量获取计数**的优化方案。

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mziayxzIeJiasj9KxcEialTZibP08lQ4JGaTfnJEJv03taibW1OZBibqqIDVYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=5)

原始方案，通过拼装 key 来区分同一个 msg_id 的不同业务计数。

可以升级为，同一个 value 来存储多个计数。  

![](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mziaT1T3mbB49QauUibMeQwfmv7vnn7528Dg2lFiav743d8Imx0ibbibbiaS8w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=6)

如上图所示，同一个 msg_id 的四个计数，存储在一个 value 里，从而避免多次 redis 访问。  
_画外音：__通过 value 来扩展，是不是很巧妙？_

**总结**

计数业务，在数据量大，并发量大的时候，要考虑的一些技术点：

1. 用缓存扛读写；

2. 服务化，计数系统与业务系统解耦；

3. 水平切分扩展吞吐量、数据量、读写量；

4. 要考虑扩展性，数据库层面常见的优化有：列扩展，行扩展两种方式；

5. 要考虑批量操作，缓存层面常见的优化有：一个 value 存储多个业务计数；

  

计数系统架构优化，你学废了吗？

知其然，知其所以然。

**思路比结论更重要。**

== 全文完 ==

有架构合集吗？

合集一：《[流量从 10 万到 10 亿，一定会遇到的 80 个架构问题（8000 字长文）](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651974945&idx=1&sn=58ff54415ddf2dd52d03f47a6790344b&scene=21#wechat_redirect)》

画外音：从理论到实践，15 年架构师生涯的系统性总结。

合集二：《[关于即时通讯架构的一切！](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651975468&idx=1&sn=54ab265bee4998da9a0d32091699cb1d&scene=21#wechat_redirect)》

画外音：职业生涯前 5 年，都在做 IM 架构。

如何提问？免费加入星球，一起技术交流。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/YrezxckhYOyHicSCibf68mt4pGa2pPmkZNbq2icyf4jsbKwnJJrtlH2sg6nZdy37BC6IaYlNJbu9iahHWBmDrOib6XQ/640?wx_fmt=jpeg&from=appmsg&randomid=g1weg7nk&wxfrom=5&wx_lazy=1&tp=webp#imgIndex=17)

直播：AI 会取代我的工作吗？

欢迎预约！