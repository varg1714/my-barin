---
source: https://mp.weixin.qq.com/s/ImrftOwc6UEuXxbHBDTgaA
create: 2024-09-03 10:05
read: false
---
![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe94cQiccAo2zibZETiaOnMVLNQAO0Zne2x8KlehRMR8AsOTW90m1pAicBEw5wBJFkQiax8ricKGbKibEKV8gQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/mmbiz_gif/VY8SELNGe96srmm5CxquJGSP4BbZA8IDLUj8l7F3tzrm8VuILsgUPDciaDLtvQx78DbkrhAqOJicxze5ZUO5ZLNg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&tp=webp)

  

ğŸ‘‰ç›®å½•

1Â é™æµçš„ç›®çš„

2 é™æµç®—æ³•çš„å®ç°

3 é™æµçš„å®ç°æ–¹å¼

4Â é™æµç­–ç•¥

5 é™æµè€ƒè™‘çš„å› ç´ 

åœ¨è½¯ä»¶æ¶æ„ä¸­ï¼Œé™æµæ˜¯ä¸€ç§æ§åˆ¶èµ„æºä½¿ç”¨å’Œä¿æŠ¤ç³»ç»Ÿå®‰å…¨çš„é‡è¦æœºåˆ¶ã€‚å®ƒé€šè¿‡é™åˆ¶åœ¨ä¸€å®šæ—¶é—´å†…å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œæ¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚æœ¬æ–‡ç”±è…¾è®¯äº‘å¤©å¾¡ä¸šåŠ¡å®‰å…¨å·¥ç¨‹å¸ˆç‹é¡ºé©°æ’°å†™ï¼Œæ¬¢è¿é˜…è¯»~

  

å…³æ³¨è…¾è®¯äº‘å¼€å‘è€…ï¼Œä¸€æ‰‹æŠ€æœ¯å¹²è´§æå‰è§£é”ğŸ‘‡

  

  

# 01

  

  

é™æµçš„ç›®çš„

  

é™æµä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ï¼š

*   **é˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼š**ç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹ä»èƒ½ä¿æŒç¨³å®šè¿è¡Œã€‚
    
*   **ä¿è¯æœåŠ¡è´¨é‡ï¼š**ä¸ºæ‰€æœ‰ç”¨æˆ·æä¾›å…¬å¹³çš„æœåŠ¡ï¼Œé¿å…æŸäº›ç”¨æˆ·å ç”¨è¿‡å¤šèµ„æºã€‚
    

  

  

  

# 02

  

  

é™æµç®—æ³•çš„å®ç°

  

 2.1 å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•

  

å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•æ˜¯ä¸€ç§åŸºæœ¬çš„é™æµæ–¹æ³•ï¼Œå®ƒé€šè¿‡åœ¨å›ºå®šæ—¶é—´çª—å£å†…è·Ÿè¸ªè¯·æ±‚çš„æ•°é‡æ¥å®ç°é™æµã€‚

  

```
// è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°æ¡ˆä¾‹
package main

import ( "fmt"
  "sync"
  "time" )

// FixedWindowCounter ç»“æ„ä½“å®ç°å›ºå®šçª—å£è®¡æ•°å™¨é™æµç®—æ³•ã€‚
// mu ç”¨äºåŒæ­¥è®¿é—®ï¼Œä¿è¯å¹¶å‘å®‰å…¨ã€‚
// count è®°å½•å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°é‡ã€‚
// limit æ˜¯æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°é‡ã€‚
// window è®°å½•å½“å‰æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´ã€‚
// duration æ˜¯æ—¶é—´çª—å£çš„æŒç»­æ—¶é—´ã€‚
type FixedWindowCounter struct {
  mu        sync.Mutex
  count     int
  limit     int
  window    time.Time
  duration  time.Duration
}

// NewFixedWindowCounter æ„é€ å‡½æ•°åˆå§‹åŒ– FixedWindowCounter å®ä¾‹ã€‚
// limit å‚æ•°å®šä¹‰äº†æ¯ä¸ªæ—¶é—´çª—å£å†…å…è®¸çš„è¯·æ±‚æ•°é‡ã€‚
// duration å‚æ•°å®šä¹‰äº†æ—¶é—´çª—å£çš„å¤§å°ã€‚
func NewFixedWindowCounter(limit int, duration time.Duration) *FixedWindowCounter {
  return &FixedWindowCounter{
    limit:   limit,
    window:  time.Now(),   // è®¾ç½®å½“å‰æ—¶é—´ä½œä¸ºçª—å£çš„å¼€å§‹æ—¶é—´ã€‚
    duration: duration,    // è®¾ç½®æ—¶é—´çª—å£çš„æŒç»­æ—¶é—´ã€‚
  }
}

// Allow æ–¹æ³•ç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦è¢«å…è®¸ã€‚
// é¦–å…ˆé€šè¿‡äº’æ–¥é”ä¿è¯æ–¹æ³•çš„åŸå­æ€§ã€‚
func (f *FixedWindowCounter) Allow() bool {
  f.mu.Lock()
  defer f.mu.Unlock()

  now := time.Now() // è·å–å½“å‰æ—¶é—´ã€‚

  // å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡äº†çª—å£çš„ç»“æŸæ—¶é—´ï¼Œé‡ç½®è®¡æ•°å™¨å’Œçª—å£å¼€å§‹æ—¶é—´ã€‚
  if now.After(f.window.Add(f.duration)) {
    f.count = 0
    f.window = now
  }

  // å¦‚æœå½“å‰è®¡æ•°å°äºé™åˆ¶ï¼Œåˆ™å¢åŠ è®¡æ•°å¹¶å…è®¸è¯·æ±‚ã€‚
  if f.count < f.limit {
    f.count++
    return true
  }
  // å¦‚æœè®¡æ•°è¾¾åˆ°é™åˆ¶ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚
  return false
}

// main å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ã€‚
func main() {
  // åˆ›å»ºä¸€ä¸ªæ–°çš„é™æµå™¨ï¼Œè®¾ç½®æ¯åˆ†é’Ÿï¼ˆtime.Minuteï¼‰åªå…è®¸10ä¸ªè¯·æ±‚ã€‚
  limiter := NewFixedWindowCounter(10, time.Minute)

  // æ¨¡æ‹Ÿ15ä¸ªè¯·æ±‚ï¼Œè§‚å¯Ÿé™æµæ•ˆæœã€‚
  for i := 0; i < 15; i++ {
    if limiter.Allow() {
      fmt.Println("Request", i+1, "allowed")
    } else {
      fmt.Println("Request", i+1, "rejected")
    }
  }
}
```

  

**å®ç°åŸç†ï¼š** å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•é€šè¿‡è®¾ç½®ä¸€ä¸ªå›ºå®šçš„æ—¶é—´çª—å£ï¼ˆä¾‹å¦‚æ¯åˆ†é’Ÿï¼‰å’Œä¸€ä¸ªåœ¨è¿™ä¸ªçª—å£å†…å…è®¸çš„è¯·æ±‚æ•°é‡é™åˆ¶ï¼ˆä¾‹å¦‚ 10 ä¸ªè¯·æ±‚ï¼‰ã€‚åœ¨æ¯ä¸ªæ—¶é—´çª—å£å¼€å§‹æ—¶ï¼Œè®¡æ•°å™¨é‡ç½®ä¸ºé›¶ï¼Œéšç€è¯·æ±‚çš„åˆ°æ¥ï¼Œè®¡æ•°å™¨é€’å¢ã€‚å½“è®¡æ•°å™¨è¾¾åˆ°é™åˆ¶æ—¶ï¼Œåç»­çš„è¯·æ±‚å°†è¢«æ‹’ç»ï¼Œç›´åˆ°çª—å£é‡ç½®ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   å®ç°ç®€å•ç›´è§‚ã€‚
    
*   å®¹æ˜“ç†è§£å’Œå®ç°ã€‚
    
*   å¯ä»¥ä¿è¯åœ¨ä»»ä½•ç»™å®šçš„å›ºå®šæ—¶é—´çª—å£å†…ï¼Œè¯·æ±‚çš„æ•°é‡ä¸ä¼šè¶…è¿‡è®¾å®šçš„é˜ˆå€¼ã€‚
    

  

**ç¼ºç‚¹ï¼š**

*   åœ¨çª—å£åˆ‡æ¢çš„ç¬é—´å¯èƒ½ä¼šæœ‰è¯·æ±‚é«˜å³°ï¼Œå› ä¸ºè®¡æ•°å™¨é‡ç½®å¯èƒ½å¯¼è‡´å¤§é‡è¯·æ±‚å‡ ä¹åŒæ—¶è¢«å¤„ç†ã€‚
    
*   æ— æ³•å¹³æ»‘åœ°å¤„ç†çªå‘æµé‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ä½“éªŒä¸ä½³ã€‚  
    

  

å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•é€‚ç”¨äºè¯·æ±‚åˆ†å¸ƒç›¸å¯¹å‡åŒ€çš„åœºæ™¯ï¼Œä½†åœ¨è¯·æ±‚å¯èƒ½åœ¨çŸ­æ—¶é—´å†…é›†ä¸­åˆ°è¾¾çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘æ›´å¤æ‚çš„é™æµç®—æ³•ï¼Œå¦‚æ»‘åŠ¨çª—å£æˆ–ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚

  

 2.2Â æ»‘åŠ¨çª—å£ç®—æ³•

æ»‘åŠ¨çª—å£ç®—æ³•æ˜¯å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„ä¸€ä¸ªæ”¹è¿›ï¼Œå®ƒé€šè¿‡è¦†ç›–å¤šä¸ªæ—¶é—´æ®µæ¥å¹³æ»‘è¯·æ±‚æµé‡ï¼Œé¿å…ç¬æ—¶é«˜å³°ã€‚è¿™ç§ç®—æ³•é€šå¸¸éœ€è¦ä½¿ç”¨æ›´é«˜çº§çš„æ•°æ®ç»“æ„ï¼Œå¦‚æ—¶é—´è½®ï¼ˆTiming Wheelï¼‰ï¼Œæ¥å®ç°ã€‚

  

```
// è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°æ¡ˆä¾‹ï¼Œè¿™ä¸ªä»£ç ç¤ºä¾‹ä»…ç”¨äºè¯´æ˜æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„é€»è¾‘ï¼Œå¹¶éå®Œæ•´çš„å·¥ä½œä»£ç ã€‚

package main

import ( "fmt"
  "sync"
  "time" )

// SlidingWindowLimiter ç»“æ„ä½“å®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•ã€‚
type SlidingWindowLimiter struct {
  mutex       sync.Mutex
  counters    []int
  limit       int
  windowStart time.Time
  windowDuration time.Duration
  interval    time.Duration
}

// NewSlidingWindowLimiter æ„é€ å‡½æ•°åˆå§‹åŒ– SlidingWindowLimiter å®ä¾‹ã€‚
func NewSlidingWindowLimiter(limit int, windowDuration time.Duration, interval time.Duration) *SlidingWindowLimiter {
  buckets := int(windowDuration / interval)
  return &SlidingWindowLimiter{
    counters:    make([]int, buckets),
    limit:       limit,
    windowStart: time.Now(),
    windowDuration: windowDuration,
    interval:    interval,
  }
}

// Allow æ–¹æ³•ç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦è¢«å…è®¸ï¼Œå¹¶å®ç°æ»‘åŠ¨çª—å£çš„é€»è¾‘ã€‚
func (s *SlidingWindowLimiter) Allow() bool {
  s.mutex.Lock()
  defer s.mutex.Unlock()

  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»‘åŠ¨çª—å£
  if time.Since(s.windowStart) > s.windowDuration {
    s.slideWindow()
  }

  now := time.Now()
  index := int((now.UnixNano() - s.windowStart.UnixNano()) / s.interval.Nanoseconds()) % len(s.counters)

  if s.counters[index] < s.limit {
    s.counters[index]++
    return true
  }
  return false
}

// slideWindow æ–¹æ³•å®ç°æ»‘åŠ¨çª—å£é€»è¾‘ï¼Œç§»é™¤æœ€æ—§çš„æ—¶é—´æ®µå¹¶é‡ç½®è®¡æ•°å™¨ã€‚
func (s *SlidingWindowLimiter) slideWindow() {
  // æ»‘åŠ¨çª—å£ï¼Œå¿½ç•¥æœ€æ—§çš„æ—¶é—´æ®µ
  copy(s.counters, s.counters[1:])
  // é‡ç½®æœ€åä¸€ä¸ªæ—¶é—´æ®µçš„è®¡æ•°å™¨
  s.counters[len(s.counters)-1] = 0
  // æ›´æ–°çª—å£å¼€å§‹æ—¶é—´
  s.windowStart = time.Now()
}

// main å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ã€‚
func main() {
  limiter := NewSlidingWindowLimiter(1, time.Second, 10*time.Millisecond)

  for i := 0; i < 100; i++ {
    if limiter.Allow() {
      fmt.Println("Request", i+1, "allowed")
    } else {
      fmt.Println("Request", i+1, "rejected")
    }
  }
}
```

**å®ç°åŸç†ï¼š**æ»‘åŠ¨çª—å£ç®—æ³•é€šè¿‡å°†æ—¶é—´åˆ†ä¸ºå¤šä¸ªå°çš„æ—¶é—´æ®µï¼Œæ¯ä¸ªæ—¶é—´æ®µå†…ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ã€‚å½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå®ƒä¼šè¢«åˆ†é…åˆ°å½“å‰æ—¶é—´æ‰€åœ¨çš„å°æ—¶é—´æ®µï¼Œå¹¶æ£€æŸ¥è¯¥æ—¶é—´æ®µçš„è®¡æ•°å™¨æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶ã€‚å¦‚æœæœªè¾¾åˆ°ï¼Œåˆ™å…è®¸è¯·æ±‚å¹¶å¢åŠ è®¡æ•°ï¼›å¦‚æœå·²è¾¾åˆ°ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—§çš„æ—¶é—´æ®µä¼šæ·¡å‡ºçª—å£ï¼Œæ–°çš„æ—¶é—´æ®µä¼šåŠ å…¥ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   ç›¸æ¯”å›ºå®šçª—å£ç®—æ³•ï¼Œæ»‘åŠ¨çª—å£ç®—æ³•èƒ½å¤Ÿæ›´å¹³æ»‘åœ°å¤„ç†è¯·æ±‚ï¼Œé¿å…ç¬æ—¶é«˜å³°ã€‚
    
*   å¯ä»¥æä¾›æ›´ç»†è‡´çš„æµé‡æ§åˆ¶ã€‚
    

**ç¼ºç‚¹ï¼š**

*   å®ç°ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦ç»´æŠ¤å¤šä¸ªè®¡æ•°å™¨å’Œæ—¶é—´ç´¢å¼•ã€‚
    
*   å¯¹å†…å­˜å’Œè®¡ç®—çš„è¦æ±‚æ›´é«˜ã€‚
    

  

æ»‘åŠ¨çª—å£ç®—æ³•é€‚ç”¨äºéœ€è¦å¹³æ»‘æµé‡æ§åˆ¶çš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯åœ¨é¢å¯¹çªå‘æµé‡æ—¶ï¼Œèƒ½å¤Ÿæä¾›æ¯”å›ºå®šçª—å£è®¡æ•°å™¨æ›´ä¼˜çš„æµé‡æ§åˆ¶æ•ˆæœã€‚

  

 2.3 æ¼æ¡¶ç®—æ³•

æ¼æ¡¶ç®—æ³•æ˜¯ä¸€ç§ç»å…¸çš„æµé‡æ§åˆ¶æ–¹æ³•ï¼Œç‰¹åˆ«é€‚åˆäºå¹³æ»‘çªå‘æµé‡ï¼Œç¡®ä¿æ•°æ®ä»¥å‡åŒ€çš„é€Ÿç‡è¢«å¤„ç†ã€‚

```
// è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°æ¡ˆä¾‹ï¼Œè¿™ä¸ªä»£ç ç¤ºä¾‹ä»…ç”¨äºè¯´æ˜æ¼æ¡¶ç®—æ³•çš„åŸºæœ¬é€»è¾‘ï¼Œå¹¶éå®Œæ•´çš„å·¥ä½œä»£ç ã€‚

package main

import (
    "fmt"
    "time"
)

// LeakyBucket ç»“æ„ä½“ï¼ŒåŒ…å«è¯·æ±‚é˜Ÿåˆ—
type LeakyBucket struct {
    queue chan struct{} // è¯·æ±‚é˜Ÿåˆ—
}

// NewLeakyBucket åˆ›å»ºä¸€ä¸ªæ–°çš„æ¼æ¡¶å®ä¾‹
func NewLeakyBucket(capacity int) *LeakyBucket {
    return &LeakyBucket{
       queue: make(chan struct{}, capacity),
    }
}

// push å°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºè¯·æ±‚è¢«ä¸¢å¼ƒ
func (lb *LeakyBucket) push() bool {
    // å¦‚æœé€šé“å¯ä»¥å‘é€ï¼Œè¯·æ±‚è¢«æ¥å—
    select {
    case lb.queue <- struct{}{}:
       return true
    default:
       return false
    }
}

// process ä»é˜Ÿåˆ—ä¸­å–å‡ºè¯·æ±‚å¹¶æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
func (lb *LeakyBucket) process() {
    for range lb.queue { // ä½¿ç”¨ range æ¥æŒç»­æ¥æ”¶é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
       fmt.Println("Request processed at", time.Now().Format("2006-01-02 15:04:05"))
       time.Sleep(100 * time.Millisecond) // æ¨¡æ‹Ÿè¯·æ±‚å¤„ç†æ—¶é—´
    }
}

func main() {
    lb := NewLeakyBucket(5) // åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º5çš„æ¼æ¡¶

    // å¯åŠ¨è¯·æ±‚å¤„ç†å¾ªç¯
    go lb.process()

    // æ¨¡æ‹Ÿè¯·æ±‚
    for i := 0; i < 10; i++ {
       accepted := lb.push()
       if accepted {
          fmt.Printf("Request %d accepted at %v\n", i+1, time.Now().Format("2006-01-02 15:04:05"))
       } else {
          fmt.Printf("Request %d rejected at %v\n", i+1, time.Now().Format("2006-01-02 15:04:05"))
       }
    }
    time.Sleep(2 * time.Second)
}
```

  

**å®ç°åŸç†ï¼š**é€šè¿‡ä¸€ä¸ªå›ºå®šå®¹é‡çš„é˜Ÿåˆ—æ¥æ¨¡æ‹Ÿæ¡¶ï¼Œä»¥æ’å®šé€Ÿç‡ä»æ¡¶ä¸­å–å‡ºè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ— è®ºè¯·æ±‚åˆ°è¾¾çš„é¢‘ç‡å¦‚ä½•ï¼Œéƒ½ä¿è¯è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦è¢«å¤„ç†ï¼Œä»è€Œå¹³æ»‘æµé‡å¹¶é˜²æ­¢æµé‡çªå¢ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   èƒ½å¤Ÿå¼ºåˆ¶å®ç°å›ºå®šçš„æ•°æ®å¤„ç†é€Ÿç‡ï¼Œå¹³æ»‘æµé‡ã€‚
    
*   å³ä½¿é¢å¯¹çªå‘æµé‡ï¼Œä¹Ÿèƒ½ä¿æŒç¨³å®šçš„å¤„ç†é€Ÿç‡ã€‚
    

  

**ç¼ºç‚¹ï¼š**

*   å¯¹äºçªå‘æµé‡çš„å¤„ç†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½ä¼šå»¶è¿Ÿå¤„ç†ã€‚
    
*   å®ç°ç›¸å¯¹ç®€å•ï¼Œä½†éœ€è¦ç»´æŠ¤æ¡¶çš„çŠ¶æ€ã€‚
    

  

æ¼æ¡¶ç®—æ³•é€‚ç”¨äºéœ€è¦å¼ºåˆ¶æ‰§è¡Œå›ºå®šé€Ÿç‡å¤„ç†çš„åœºæ™¯ï¼Œå¦‚ç½‘ç»œæµé‡æ§åˆ¶ã€API è¯·æ±‚é™åˆ¶ç­‰ã€‚é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„æ·»åŠ é€Ÿç‡ï¼Œæ¼æ¡¶ç®—æ³•èƒ½å¤Ÿæœ‰æ•ˆåœ°é¿å…ç³»ç»Ÿå› ç¬æ—¶æµé‡é«˜å³°è€Œè¿‡è½½ã€‚

  

 2.4Â ä»¤ç‰Œæ¡¶ç®—æ³•

  

ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ä¸€ç§æµè¡Œçš„é™æµç®—æ³•ï¼Œå®ƒå…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘æµé‡ï¼ŒåŒæ—¶ä¿æŒé•¿æœŸçš„å¹³å‡é€Ÿç‡ã€‚

  

```
// è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°æ¡ˆä¾‹ï¼Œè¿™ä¸ªä»£ç ç¤ºä¾‹ä»…ç”¨äºè¯´æ˜ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸºæœ¬é€»è¾‘ï¼Œå¹¶éå®Œæ•´çš„å·¥ä½œä»£ç ã€‚
package main

import ( "fmt"
    "sync"
    "time" )

// TokenBucket ç»“æ„ä½“å®ç°ä»¤ç‰Œæ¡¶é™æµç®—æ³•ã€‚
// - mu ç”¨äºåŒæ­¥è®¿é—®ï¼Œä¿è¯å¹¶å‘å®‰å…¨ã€‚
// - capacity å®šä¹‰æ¡¶çš„å®¹é‡ï¼Œå³æ¡¶ä¸­æœ€å¤šå¯ä»¥å­˜æ”¾çš„ä»¤ç‰Œæ•°ã€‚
// - tokens è¡¨ç¤ºæ¡¶ä¸­å½“å‰çš„ä»¤ç‰Œæ•°ã€‚
// - refillRate æ˜¯ä»¤ç‰Œçš„å¡«å……é€Ÿç‡ï¼Œè¡¨ç¤ºæ¯ç§’å‘æ¡¶ä¸­æ·»åŠ çš„ä»¤ç‰Œæ•°ã€‚
// - lastRefill è®°å½•ä¸Šæ¬¡å¡«å……ä»¤ç‰Œçš„æ—¶é—´ã€‚
type TokenBucket struct {
    mu         sync.Mutex
    capacity   int
    tokens     int
    refillRate float64
    lastRefill time.Time
}

// NewTokenBucket æ„é€ å‡½æ•°åˆå§‹åŒ– TokenBucket å®ä¾‹ã€‚
// - capacity å‚æ•°å®šä¹‰äº†æ¡¶çš„å®¹é‡ã€‚
// - refillRate å‚æ•°å®šä¹‰äº†æ¯ç§’å‘æ¡¶ä¸­æ·»åŠ çš„ä»¤ç‰Œæ•°ã€‚
func NewTokenBucket(capacity int, refillRate float64) *TokenBucket {
    // åˆå§‹åŒ–æ—¶æ¡¶è¢«å¡«æ»¡ï¼Œtokens å’Œ capacity ç›¸ç­‰ã€‚
    // lastRefill è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚
    return &TokenBucket{
       capacity:   capacity,
       tokens:     capacity,
       refillRate: refillRate,
       lastRefill: time.Now(),
    }
}

// Allow æ–¹æ³•ç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦è¢«å…è®¸ã€‚
func (t *TokenBucket) Allow() bool {
    t.mu.Lock() // è¿›å…¥ä¸´ç•ŒåŒºï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚
    defer t.mu.Unlock()

    now := time.Now() // è·å–å½“å‰æ—¶é—´ã€‚

    // è®¡ç®—è‡ªä¸Šæ¬¡å¡«å……ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œå¹¶è½¬æ¢ä¸ºfloat64ç±»å‹ã€‚
    timeElapsed := float64(now.Unix() - t.lastRefill.Unix())

    // æ ¹æ® refillRate è®¡ç®—åº”è¯¥æ·»åŠ çš„ä»¤ç‰Œæ•°ã€‚
    tokensToAdd := t.refillRate * timeElapsed

    // æ›´æ–°ä»¤ç‰Œæ•°ï¼Œä½†ä¸è¶…è¿‡æ¡¶çš„å®¹é‡ã€‚
    t.tokens += int(tokensToAdd)
    if t.tokens > t.capacity {
       t.tokens = t.capacity // ç¡®ä¿ä»¤ç‰Œæ•°ä¸è¶…è¿‡æ¡¶çš„å®¹é‡ã€‚
    }

    // å¦‚æœæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œåˆ™ç§»é™¤ä¸€ä¸ªä»¤ç‰Œå¹¶å…è®¸è¯·æ±‚é€šè¿‡ã€‚
    if t.tokens > 0 {
       t.tokens--         // ç§»é™¤ä¸€ä¸ªä»¤ç‰Œã€‚
       t.lastRefill = now // æ›´æ–°ä¸Šæ¬¡å¡«å……æ—¶é—´åˆ°å½“å‰æ—¶é—´ã€‚
       return true
    }

    // å¦‚æœæ¡¶ä¸­æ— ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚è¢«æ‹’ç»ã€‚
    return false
}

// main å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ã€‚
func main() {
    // åˆ›å»ºä¸€ä¸ªæ–°çš„ä»¤ç‰Œæ¡¶å®ä¾‹ï¼Œæ¡¶çš„å®¹é‡ä¸º10ï¼Œæ¯ç§’å¡«å……2ä¸ªä»¤ç‰Œã€‚
    limiter := NewTokenBucket(10, 2)

    // æ¨¡æ‹Ÿè¯·æ±‚ï¼Œè§‚å¯Ÿé™æµæ•ˆæœã€‚
    // å¾ªç¯15æ¬¡ï¼Œæ¯æ¬¡è¯·æ±‚åˆ¤æ–­æ˜¯å¦è¢«å…è®¸ã€‚
    for i := 0; i < 15; i++ {
       if limiter.Allow() {
          fmt.Println("Request", i+1, "allowed")
       } else {
          fmt.Println("Request", i+1, "rejected")
       }
    }
}
```

**å®ç°åŸç†ï¼š**ä»¤ç‰Œæ¡¶ç®—æ³•ä½¿ç”¨ä¸€ä¸ªä»¤ç‰Œæ¡¶æ¥è°ƒèŠ‚æ•°æ®æµçš„é€Ÿç‡ï¼Œå…è®¸ä¸€å®šç¨‹åº¦çš„æµé‡çªå‘ã€‚æ¡¶åˆå§‹æ—¶ä¸ºç©ºï¼Œå¹¶ä»¥å›ºå®šçš„é€Ÿç‡å¡«å……ä»¤ç‰Œï¼Œç›´è‡³è¾¾åˆ°é¢„è®¾çš„å®¹é‡ä¸Šé™ã€‚ä¸æ¼æ¡¶ç®—æ³•ä¸åŒï¼Œä»¤ç‰Œæ¡¶ç®—æ³•åœ¨æ¡¶æœªæ»¡æ—¶ï¼Œå¯ä»¥åœ¨æ¯ä¸ªæ—¶é—´é—´éš”å†…å‘æ¡¶ä¸­æ·»åŠ å¤šä¸ªä»¤ç‰Œï¼Œä»è€Œç§¯ç´¯å¤„ç†çªå‘è¯·æ±‚çš„èƒ½åŠ›ã€‚å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå¦‚æœæ¡¶ä¸­å­˜åœ¨ä»¤ç‰Œï¼Œç®—æ³•ä¼šä»æ¡¶ä¸­ç§»é™¤ç›¸åº”æ•°é‡çš„ä»¤ç‰Œæ¥å¤„ç†è¯·æ±‚ã€‚å¦‚æœæ¡¶ä¸­çš„ä»¤ç‰Œä¸è¶³ï¼Œè¯·æ±‚å°†è¢«å»¶è¿Ÿå¤„ç†æˆ–æ ¹æ®ç­–ç•¥æ‹’ç»æœåŠ¡ã€‚å¦‚æœæ¡¶å·²æ»¡ï¼Œé¢å¤–çš„ä»¤ç‰Œå°†ä¸ä¼šè¢«æ·»åŠ ï¼Œç¡®ä¿äº†ä»¤ç‰Œæ•°é‡ä¸ä¼šè¶…è¿‡æ¡¶çš„å®¹é‡é™åˆ¶ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘æµé‡ï¼Œæ›´åŠ çµæ´»ã€‚
    
*   å¯ä»¥å¹³æ»‘æµé‡ï¼ŒåŒæ—¶åœ¨æ¡¶æœªæ»¡æ—¶å¿«é€Ÿå¤„ç†è¯·æ±‚ã€‚
    

  

**ç¼ºç‚¹ï¼š**

*   å®ç°ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦ç»´æŠ¤æ¡¶çš„çŠ¶æ€å’Œæ—¶é—´ã€‚
    
*   å¯¹äºè®¡ç®—å’ŒåŒæ­¥çš„è¦æ±‚æ›´é«˜ã€‚
    

  

ä»¤ç‰Œæ¡¶ç®—æ³•é€‚ç”¨äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åœºæ™¯ï¼Œå¦‚ç½‘ç»œé€šä¿¡ã€API è°ƒç”¨ç­‰ã€‚é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„å¡«å……é€Ÿç‡å’Œæ¡¶çš„å®¹é‡ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿæœ‰æ•ˆåœ°å¹³è¡¡æµé‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼ŒåŒæ—¶å…è®¸åœ¨çŸ­æœŸå†…å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚

  

  

  

# 03

  

  

é™æµçš„å®ç°æ–¹å¼

é™æµå¯ä»¥é€šè¿‡ä¸åŒçš„ç»„ä»¶å’Œå±‚æ¬¡å®ç°ã€‚

 3.1Â åº”ç”¨å±‚é™æµ

åº”ç”¨å±‚é™æµæ˜¯åœ¨åº”ç”¨ç¨‹åºçš„ä»£ç ä¸­ç›´æ¥å®ç°é™æµé€»è¾‘ï¼Œè¿™é€šå¸¸æ˜¯é€šè¿‡ä½¿ç”¨ä¸­é—´ä»¶æ¥å®Œæˆçš„ã€‚ä¸­é—´ä»¶å¯ä»¥åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰å…ˆè¿›è¡Œé™æµæ£€æŸ¥ï¼Œä»¥å†³å®šæ˜¯å¦ç»§ç»­å¤„ç†è¯·æ±‚æˆ–è€…è¿”å›é”™è¯¯ä¿¡æ¯ã€‚

  

```
// è¿™æ˜¯ä¸€ä¸ªä¼ªä»£ç æ¡ˆä¾‹ï¼Œæ¼”ç¤ºå®ç°é€»è¾‘
package main

import (
  "fmt"
  "github.com/gin-gonic/gin" // å¼•å…¥Ginæ¡†æ¶ï¼Œç”¨äºæ„å»ºWebæœåŠ¡å™¨å’Œå¤„ç†HTTPè¯·æ±‚
  "net/http"
  "sync"                // å¼•å…¥syncåŒ…ï¼Œç”¨äºåŒæ­¥åŸè¯­ï¼Œå¦‚äº’æ–¥é”
  "time"                 // å¼•å…¥timeåŒ…ï¼Œç”¨äºæ—¶é—´ç›¸å…³æ“ä½œ
)

// TokenBucket ç»“æ„ä½“å®ç°ä»¤ç‰Œæ¡¶é™æµç®—æ³•ã€‚
// å®ƒåŒ…å«äº’æ–¥é”muç”¨äºåŒæ­¥è®¿é—®ï¼Œcapacityä»£è¡¨æ¡¶çš„å®¹é‡ï¼Œ
// tokensè¡¨ç¤ºå½“å‰æ¡¶ä¸­çš„ä»¤ç‰Œæ•°ï¼ŒrefillRateæ˜¯ä»¤ç‰Œçš„å¡«å……é€Ÿç‡ï¼ˆæ¯ç§’ï¼‰ï¼Œ
// lastRefillè®°å½•ä¸Šæ¬¡å¡«å……çš„æ—¶é—´ã€‚
type TokenBucket struct {
  mu        sync.Mutex
  capacity  int
  tokens    int
  refillRate float64
  lastRefill time.Time
}

// NewTokenBucket å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„TokenBucketå®ä¾‹ã€‚
// å®ƒè®¾ç½®æ¡¶çš„å®¹é‡å’Œå¡«å……é€Ÿç‡ï¼Œå¹¶å°†åˆå§‹ä»¤ç‰Œæ•°è®¾ä¸ºå®¹é‡çš„å€¼ã€‚
func NewTokenBucket(capacity int, refillRate float64) *TokenBucket {
  return &TokenBucket{
    capacity:  capacity,
    tokens:    capacity,  // åˆå§‹åŒ–æ—¶æ¡¶è¢«å¡«æ»¡
    refillRate: refillRate,
    lastRefill: time.Now(), // è®°å½•åˆ›å»ºæ—¶çš„æ—¶é—´ä½œä¸ºä¸Šæ¬¡å¡«å……æ—¶é—´
  }
}

// Allow æ–¹æ³•ç”¨äºæ£€æŸ¥æ˜¯å¦å…è®¸é€šè¿‡å½“å‰è¯·æ±‚ã€‚
// å®ƒé¦–å…ˆè·å–é”ï¼Œç„¶åè®¡ç®—è‡ªä¸Šæ¬¡å¡«å……ä»¥æ¥åº”è¯¥æ·»åŠ çš„ä»¤ç‰Œæ•°ï¼Œ
// æ›´æ–°æ¡¶ä¸­çš„ä»¤ç‰Œæ•°ï¼Œä½†ä¸è¶…è¿‡æ¡¶çš„å®¹é‡ã€‚
// å¦‚æœæ¡¶ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä»¤ç‰Œï¼Œå®ƒå°†å‡å°‘ä¸€ä¸ªä»¤ç‰Œå¹¶è¿”å›trueï¼Œè¡¨ç¤ºè¯·æ±‚è¢«å…è®¸ã€‚
// å¦‚æœæ¡¶ä¸ºç©ºï¼Œåˆ™è¿”å›falseï¼Œè¡¨ç¤ºè¯·æ±‚è¢«æ‹’ç»ã€‚
func (tb *TokenBucket) Allow() bool {
  tb.mu.Lock() // è·å–é”ï¼Œä¿è¯æ“ä½œçš„åŸå­æ€§
  defer tb.mu.Unlock()

  now := time.Now() // è·å–å½“å‰æ—¶é—´
  // è®¡ç®—è‡ªä¸Šæ¬¡å¡«å……ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œç„¶åä¹˜ä»¥å¡«å……é€Ÿç‡ï¼Œå¾—åˆ°åº”æ·»åŠ çš„ä»¤ç‰Œæ•°
  tokensToAdd := int(tb.refillRate * (now.Sub(tb.lastRefill).Seconds()))
  tb.tokens += tokensToAdd // æ›´æ–°æ¡¶ä¸­çš„ä»¤ç‰Œæ•°
  if tb.tokens > tb.capacity {
    tb.tokens = tb.capacity // ç¡®ä¿ä¸è¶…è¿‡æ¡¶çš„å®¹é‡
  }

  if tb.tokens > 0 {
    tb.tokens-- // å¤„ç†è¯·æ±‚ï¼Œå‡å°‘ä¸€ä¸ªä»¤ç‰Œ
    tb.lastRefill = now // æ›´æ–°ä¸Šæ¬¡å¡«å……æ—¶é—´ä¸ºå½“å‰æ—¶é—´
    return true
  }
  return false // å¦‚æœæ¡¶ä¸ºç©ºï¼Œè¿”å›false
}

// Middleware å‡½æ•°è¿”å›ä¸€ä¸ªGinä¸­é—´ä»¶ï¼Œè¯¥ä¸­é—´ä»¶ä½¿ç”¨TokenBucketæ¥é™æµã€‚
// å¦‚æœTokenBucketçš„Allowæ–¹æ³•è¿”å›falseï¼Œä¸­é—´ä»¶å°†ä¸­æ–­è¯·æ±‚å¤„ç†ï¼Œ
// å¹¶è¿”å›HTTPçŠ¶æ€ç 429ï¼ˆToo Many Requestsï¼‰å’Œé”™è¯¯ä¿¡æ¯ã€‚
// å¦‚æœè¯·æ±‚è¢«å…è®¸ï¼Œä¸­é—´ä»¶å°†è°ƒç”¨c.Next()ç»§ç»­æ‰§è¡Œåç»­çš„å¤„ç†é“¾ã€‚
func Middleware(tb *TokenBucket) gin.HandlerFunc {
  return func(c *gin.Context) {
    // åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œè°ƒç”¨TokenBucketçš„Allowæ–¹æ³•æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚
    if !tb.Allow() {
      // å¦‚æœè¯·æ±‚è¢«é™æµï¼Œè¿”å›é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 
      c.JSON(http.StatusTooManyRequests, gin.H{"error": "too many requests"})
      c.Abort() // ä¸­æ–­è¯·æ±‚å¤„ç†
      return
    }
    // å¦‚æœè¯·æ±‚æœªè¢«é™æµï¼Œç»§ç»­æ‰§è¡Œåç»­çš„å¤„ç†é“¾
    c.Next()
  }
}

func main() {
  // åˆ›å»ºä¸€ä¸ªGinçš„é»˜è®¤å®ä¾‹ï¼Œç”¨äºWebæœåŠ¡
  r := gin.Default()

  // åˆ›å»ºTokenBucketå®ä¾‹ï¼Œç”¨äºé™æµæ§åˆ¶
  tb := NewTokenBucket(10, 1.0) // æ¡¶çš„å®¹é‡ä¸º10ï¼Œæ¯ç§’å¡«å……1ä¸ªä»¤ç‰Œ

  // ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„é™æµä¸­é—´ä»¶
  r.Use(Middleware(tb))

  // å®šä¹‰ä¸€ä¸ªç®€å•çš„è·¯ç”±ï¼Œå½“è®¿é—®/helloè·¯å¾„æ—¶ï¼Œè¿”å›JSONæ ¼å¼çš„æ¶ˆæ¯
  r.GET("/hello", func(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{"message": "hello world"})
  })

  // å¯åŠ¨GinæœåŠ¡å™¨ï¼Œé»˜è®¤ç›‘å¬åœ¨0.0.0.0:8080
  r.Run()
}
```

**å®ç°åŸç†ï¼š**åœ¨ Web åº”ç”¨ç¨‹åºä¸­ï¼Œé™æµå¯ä»¥é€šè¿‡ä¸­é—´ä»¶å®ç°ã€‚ä¸­é—´ä»¶åœ¨å¤„ç† HTTP è¯·æ±‚ä¹‹å‰å…ˆæ‰§è¡Œï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œèº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€é™æµç­‰æ“ä½œã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª `TokenBucket` ç±»å‹çš„é™æµå™¨ï¼Œå¹¶å®ç°äº†ä¸€ä¸ª `Middleware` å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ª `TokenBucket` å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª Gin ä¸­é—´ä»¶å¤„ç†å™¨ã€‚ä¸­é—´ä»¶åœ¨å¤„ç†è¯·æ±‚æ—¶é¦–å…ˆè°ƒç”¨ `Allow` æ–¹æ³•æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚é€šè¿‡ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   æ˜“äºå®ç°å’Œé›†æˆï¼Œå¯ä»¥è½»æ¾åœ°æ·»åŠ åˆ°ç°æœ‰çš„ Web åº”ç”¨ç¨‹åºä¸­ã€‚
    
*   ç»†ç²’åº¦æ§åˆ¶ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„è·¯ç”±æˆ–ç”¨æˆ·åº”ç”¨ä¸åŒçš„é™æµç­–ç•¥ã€‚
    

  

**ç¼ºç‚¹ï¼š**

*   å¯èƒ½ä¼šå¢åŠ è¯·æ±‚å¤„ç†çš„å»¶è¿Ÿï¼Œå› ä¸ºä¸­é—´ä»¶éœ€è¦åœ¨æ¯æ¬¡è¯·æ±‚æ—¶è¿›è¡ŒåŒæ­¥æ“ä½œã€‚
    
*   å¦‚æœä¸æ°å½“åœ°ä½¿ç”¨ï¼Œå¯èƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚
    

  

åº”ç”¨å±‚é™æµé€‚ç”¨äºéœ€è¦ç»†ç²’åº¦æ§åˆ¶çš„åœºæ™¯ï¼Œå…è®¸å¼€å‘è€…æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚å®šåˆ¶é™æµç­–ç•¥ã€‚é€šè¿‡åˆç†é…ç½®é™æµå™¨çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ä¿è¯æœåŠ¡è´¨é‡çš„åŒæ—¶ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„ååé‡å’Œç¨³å®šæ€§ã€‚

  

 3.2 ä»£ç†å±‚é™æµ

  

ä»£ç†å±‚é™æµæ˜¯åœ¨ç½‘ç»œé€šä¿¡çš„ä»£ç†æœåŠ¡å™¨å±‚é¢å®ç°é™æµï¼Œä¾‹å¦‚ä½¿ç”¨ Nginx æˆ– HAProxy ç­‰ä»£ç†æœåŠ¡å™¨ã€‚è¿™ç§æ–¹æ³•å¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾åç«¯æœåŠ¡ä¹‹å‰å¯¹å®ƒä»¬è¿›è¡Œé™åˆ¶ï¼Œä»è€Œä¿æŠ¤åç«¯æœåŠ¡ä¸å—è¿‡å¤šè¯·æ±‚çš„å†²å‡»ã€‚

  

#### **Nginx é…ç½®ç¤ºä¾‹**

  

```
http {
    # å®šä¹‰ä¸€ä¸ªé™æµåŒºåŸŸï¼Œä½¿ç”¨å…±äº«å†…å­˜å­˜å‚¨çŠ¶æ€
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;

    server {
        # ç›‘å¬80ç«¯å£
        listen 80;

        # å®šä¹‰ä¸€ä¸ªlocationå—ï¼Œç”¨äºåŒ¹é…ç‰¹å®šçš„è¯·æ±‚è·¯å¾„
        location /api/ {
            # åº”ç”¨é™æµè§„åˆ™
            limit_req zone=mylimit burst=5 nodelay;

            # ä»£ç†è¯·æ±‚åˆ°åç«¯æœåŠ¡
            proxy_pass http://backend/;
        }
    }
}
```

**å®ç°åŸç†ï¼š**åœ¨ Nginx ä¸­ï¼Œé€šè¿‡å®šä¹‰ limit_req_zone æŒ‡ä»¤åˆ›å»ºä¸€ä¸ªé™æµåŒºåŸŸï¼Œå¹¶æŒ‡å®šä½¿ç”¨å…±äº«å†…å­˜æ¥å­˜å‚¨å®¢æˆ·ç«¯ IP åœ°å€å’Œå¯¹åº”çš„è¯·æ±‚è®¡æ•°ã€‚rate å‚æ•°å®šä¹‰äº†æ¯ä¸ªå®¢æˆ·ç«¯æ¯ç§’é’Ÿå…è®¸çš„è¯·æ±‚æ•°é‡ã€‚åœ¨ server å—ä¸­ï¼Œä½¿ç”¨ limit_req æŒ‡ä»¤å¼•ç”¨ä¹‹å‰å®šä¹‰çš„é™æµåŒºåŸŸï¼Œå¹¶è®¾ç½® burst å‚æ•°å…è®¸ä¸€å®šæ•°é‡çš„çªå‘è¯·æ±‚ã€‚

  

**ä¼˜ç‚¹ï¼š**

*   åœ¨ç½‘ç»œå±‚é¢è¿›è¡Œé™æµï¼Œå¯ä»¥ä¿æŠ¤æ‰€æœ‰åç«¯æœåŠ¡ï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­å•ç‹¬å®ç°é™æµé€»è¾‘ã€‚
    
*   å‡è½»äº†åç«¯æœåŠ¡çš„è´Ÿæ‹…ï¼Œå› ä¸ºå¤šä½™çš„è¯·æ±‚åœ¨åˆ°è¾¾åç«¯ä¹‹å‰å°±è¢«æ‹’ç»äº†ã€‚
    
*   é…ç½®çµæ´»ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„è¯·æ±‚è·¯å¾„å’Œå®¢æˆ·ç«¯è®¾ç½®ä¸åŒçš„é™æµè§„åˆ™ã€‚
    

  

**ç¼ºç‚¹ï¼š**

*   éœ€è¦ä»£ç†æœåŠ¡å™¨æ”¯æŒé™æµåŠŸèƒ½ï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„é…ç½®å’Œè°ƒä¼˜ã€‚
    
*   å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æœºåˆ¶æ¥åŒæ­¥çŠ¶æ€ï¼Œç¡®ä¿å…¨å±€çš„é™æµæ•ˆæœã€‚
    

  

ä»£ç†å±‚é™æµé€‚ç”¨äºéœ€è¦åœ¨å¤šä¸ªæœåŠ¡æˆ–æ•´ä¸ªåº”ç”¨å±‚é¢æ§åˆ¶è¯·æ±‚çš„åœºæ™¯ã€‚é€šè¿‡åˆç†é…ç½®ä»£ç†æœåŠ¡å™¨çš„é™æµè§„åˆ™ï¼Œå¯ä»¥åœ¨ä¸åŒçš„å±‚é¢ä¸Šä¿æŠ¤ç³»ç»Ÿï¼Œæé«˜æ•´ä½“çš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚

  

 3.3 ç¡¬ä»¶å±‚é™æµ

åœ¨ç¡¬ä»¶å±‚ï¼ˆå¦‚è´Ÿè½½å‡è¡¡å™¨ï¼‰å®ç°é™æµï¼Œå¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾åº”ç”¨æœåŠ¡å™¨ä¹‹å‰è¿›è¡Œæ§åˆ¶ã€‚

  

  

# 04

  

  

é™æµç­–ç•¥

é™æµç­–ç•¥æ˜¯ç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿå¤„ç†é¢„æœŸè´Ÿè½½å¹¶é˜²æ­¢è¿‡è½½çš„ä¸€ç³»åˆ—è§„åˆ™å’Œæªæ–½ã€‚

  

 4.1Â é˜ˆå€¼è®¾ç½®

  

é˜ˆå€¼è®¾ç½®æ˜¯é™æµç­–ç•¥çš„åŸºç¡€ï¼Œå®ƒå†³å®šäº†ç³»ç»Ÿåœ¨å•ä½æ—¶é—´å†…èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é‡ã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// RateLimiterV2 ç»“æ„ä½“å¢åŠ äº†é˜ˆå€¼è®¾ç½®åŠŸèƒ½ã€‚
type RateLimiterV2 struct {
    mu     sync.Mutex
    tokens int
    capacity  int      // æ¡¶çš„å®¹é‡ï¼Œä»£è¡¨æœ€å¤§ä»¤ç‰Œæ•°
    refillRate float64 // æ¯ç§’å¡«å……çš„ä»¤ç‰Œæ•°
    limit     int      // è¯·æ±‚å¤„ç†çš„é˜ˆå€¼ï¼Œå³æ¡¶çš„å®¹é‡
}

// NewRateLimiterV2 åˆ›å»ºä¸€ä¸ªæ–°çš„RateLimiterV2å®ä¾‹ï¼Œå¹¶è®¾ç½®é˜ˆå€¼ã€‚
func NewRateLimiterV2(capacity int, refillRate float64, limit int) *RateLimiterV2 {
    return &RateLimiterV2{
        capacity:  capacity,
        refillRate: refillRate,
        limit:     limit,
    }
}

// Allow ç°åœ¨è€ƒè™‘äº†è®¾ç½®çš„é˜ˆå€¼ã€‚
func (r *RateLimiterV2) Allow() bool {
    r.mu.Lock()
    defer r.mu.Unlock()

    // ä»¤ç‰Œæ¡¶é€»è¾‘...
    // å¦‚æœæ¡¶ä¸­çš„ä»¤ç‰Œæ•°è¾¾åˆ°æˆ–è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚
    if r.tokens >= r.limit {
        return false
    }

    // å…è®¸è¯·æ±‚é€»è¾‘...
    return true
}
```

  

 4.2 è¯·æ±‚åˆ†ç±»

è¯·æ±‚åˆ†ç±»å…è®¸å¯¹ä¸åŒç±»å‹çš„è¯·æ±‚åº”ç”¨ä¸åŒçš„é™æµè§„åˆ™ï¼Œä¾‹å¦‚ï¼Œå¯¹ API çš„ä¸åŒç«¯ç‚¹è®¾ç½®ä¸åŒçš„é˜ˆå€¼ã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// RouteLimiterMap æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œå­˜å‚¨æ¯ä¸ªè·¯ç”±è·¯å¾„å¯¹åº”çš„é™æµå™¨å®ä¾‹ã€‚
// é”®æ˜¯è·¯ç”±çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå€¼æ˜¯æŒ‡å‘RateLimiterV2ç±»å‹å®ä¾‹çš„æŒ‡é’ˆã€‚
var RouteLimiterMap = map[string]*RateLimiterV2{}

// SetRateLimiterForRoute å‡½æ•°ä¸ºæŒ‡å®šçš„è·¯ç”±è®¾ç½®ä¸€ä¸ªæ–°çš„é™æµå™¨ã€‚
// å®ƒæ¥å—è·¯ç”±çš„è·¯å¾„ã€æ¡¶çš„å®¹é‡ã€æ¯ç§’å¡«å……çš„ä»¤ç‰Œæ•°å’Œè¯·æ±‚å¤„ç†çš„é˜ˆå€¼ä½œä¸ºå‚æ•°ï¼Œ
// å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„RateLimiterV2å®ä¾‹ï¼Œå°†å…¶å­˜å‚¨åœ¨RouteLimiterMapä¸­ã€‚
func SetRateLimiterForRoute(route string, capacity int, refillRate float64, limit int) {
    // åœ¨RouteLimiterMapä¸­ä¸ºç»™å®šçš„è·¯ç”±åˆ›å»ºæˆ–æ›´æ–°é™æµå™¨å®ä¾‹ã€‚
    RouteLimiterMap[route] = NewRateLimiterV2(capacity, refillRate, limit)
}

// MiddlewareWithRoute å‡½æ•°è¿”å›ä¸€ä¸ªGinä¸­é—´ä»¶å¤„ç†å‡½æ•°ã€‚
// è¯¥ä¸­é—´ä»¶åŸºäºè·¯ç”±åç§°æ¥åº”ç”¨é™æµé€»è¾‘ã€‚
func MiddlewareWithRoute(route string) gin.HandlerFunc {
    // è¿”å›ä¸€ä¸ªGinçš„å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨å°è£…äº†é™æµé€»è¾‘ã€‚
    return func(c *gin.Context) {
        // æ£€æŸ¥RouteLimiterMapä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”è·¯ç”±çš„é™æµå™¨ã€‚
        // å¦‚æœå­˜åœ¨ï¼Œè°ƒç”¨å…¶Allowæ–¹æ³•æ¥å†³å®šå½“å‰è¯·æ±‚æ˜¯å¦åº”è¯¥è¢«å…è®¸ã€‚
        if !RouteLimiterMap[route].Allow() {
            // å¦‚æœè¯·æ±‚è¢«é™æµï¼ˆä¸å…è®¸ï¼‰ï¼Œè¿”å›HTTP 429çŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯ã€‚
            c.JSON(http.StatusTooManyRequests, gin.H{"error": "too many requests"})
            c.Abort() // ä¸­æ–­è¯·æ±‚çš„è¿›ä¸€æ­¥å¤„ç†ã€‚
            return    // é€€å‡ºä¸­é—´ä»¶å‡½æ•°ã€‚
        }
        // å¦‚æœè¯·æ±‚æœªè¢«é™æµï¼Œè°ƒç”¨c.Nextç»§ç»­æ‰§è¡ŒGinçš„å¤„ç†é“¾ã€‚
        c.Next()
    }
}
```

  

 4.3 åé¦ˆæœºåˆ¶

  

åé¦ˆæœºåˆ¶åœ¨è¯·æ±‚è¢«é™æµæ—¶å‘ç”¨æˆ·æä¾›é€‚å½“çš„åé¦ˆï¼Œå¦‚é”™è¯¯æ¶ˆæ¯æˆ–é‡è¯•åçš„æ—¶é—´ã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// AllowWithFeedback æä¾›åé¦ˆçš„è¯·æ±‚å…è®¸é€»è¾‘ã€‚
func (r *RateLimiterV2) AllowWithFeedback() (bool, string) {
    r.mu.Lock()
    defer r.mu.Unlock()

    // ä»¤ç‰Œæ¡¶é€»è¾‘...
    if r.tokens >= r.limit {
        return false, "Too many requests. Please try again later."
    }

    // å…è®¸è¯·æ±‚é€»è¾‘...
    r.tokens-- // ç§»é™¤ä»¤ç‰Œ
    return true, ""
}

// ä½¿ç”¨åé¦ˆæœºåˆ¶çš„ä¸­é—´ä»¶ã€‚
func MiddlewareWithFeedback() gin.HandlerFunc {
    return func(c *gin.Context) {
        allowed, message := RouteLimiterMap["/api/"].AllowWithFeedback()
        if !allowed {
            c.JSON(http.StatusTooManyRequests, gin.H{"error": message})
            c.Abort()
            return
        }
        c.Next()
    }
}
```

  

  

  

# 05

  

  

é™æµçš„è€ƒè™‘å› ç´ 

  

åœ¨è®¾è®¡å’Œå®æ–½é™æµæœºåˆ¶æ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘å¤šä¸ªå…³é”®å› ç´ ä»¥ç¡®ä¿é™æµç³»ç»Ÿçš„æœ‰æ•ˆæ€§å’Œå…¬å¹³æ€§ã€‚

  

 5.1Â å…¬å¹³æ€§

  

å…¬å¹³æ€§æ˜¯é™æµè®¾è®¡ä¸­çš„é¦–è¦åŸåˆ™ï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·å’Œå®¢æˆ·ç«¯èƒ½å¤Ÿå¹³ç­‰åœ°è®¿é—®æœåŠ¡ã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// FairLimiter ç»“æ„ä½“å®ç°åŸºäºç”¨æˆ·IDæˆ–IPçš„å…¬å¹³é™æµã€‚
type FairLimiter struct {
    sync.Mutex
    limits map[string]*RateLimiterV2 // ä¸ºæ¯ä¸ªç”¨æˆ·æˆ–IPç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„é™æµå™¨
}

// NewFairLimiter åˆ›å»ºä¸€ä¸ªæ–°çš„FairLimiterå®ä¾‹ã€‚
func NewFairLimiter(capacity int, refillRate float64) *FairLimiter {
    return &FairLimiter{
        limits: make(map[string]*RateLimiterV2),
    }
}

// Allow æ ¹æ®ç”¨æˆ·IDæˆ–IPå†³å®šæ˜¯å¦å…è®¸è¯·æ±‚ã€‚
func (f *FairLimiter) Allow(userID string) (bool, string) {
    f.Lock()
    defer f.Unlock()

    if _, exists := f.limits[userID]; !exists {
        // å¦‚æœç”¨æˆ·æ²¡æœ‰é™æµå™¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚
        f.limits[userID] = NewRateLimiterV2(capacity, refillRate, limit)
    }

    // ä½¿ç”¨ç”¨æˆ·çš„é™æµå™¨æ£€æŸ¥è¯·æ±‚ã€‚
    return f.limits[userID].AllowWithFeedback()
}
```

  

 5.2 çµæ´»æ€§

çµæ´»æ€§æ„å‘³ç€é™æµç­–ç•¥èƒ½å¤Ÿé€‚åº”ä¸åŒçš„æµé‡æ¨¡å¼å’Œä¸šåŠ¡éœ€æ±‚ï¼Œä¾‹å¦‚åœ¨é«˜æµé‡æœŸé—´æ”¾å®½é™åˆ¶ã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// FlexibleLimiter ç»“æ„ä½“æ˜¯ä¸€ä¸ªçµæ´»çš„é™æµå™¨ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´é™æµå‚æ•°ã€‚
type FlexibleLimiter struct {
    sync.Mutex // ä½¿ç”¨sync.Mutexæä¾›äº’æ–¥é”åŠŸèƒ½ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚
    capacity  int  // æ¡¶çš„å®¹é‡ï¼Œè¡¨ç¤ºæœ€å¤šå¯ä»¥å­˜å‚¨çš„ä»¤ç‰Œæ•°ã€‚
    refillRate float64 // ä»¤ç‰Œçš„å¡«å……é€Ÿç‡ï¼Œè¡¨ç¤ºæ¯ç§’å¯ä»¥æ–°å¢çš„ä»¤ç‰Œæ•°ã€‚
    limit      int  // è¯·æ±‚å¤„ç†çš„é˜ˆå€¼ï¼Œç”¨äºç¡®å®šæ˜¯å¦é™æµã€‚
}

// SetParams æ–¹æ³•å…è®¸åŠ¨æ€è®¾ç½®FlexibleLimiterçš„é™æµå‚æ•°ã€‚
// è¿™äº›å‚æ•°åŒ…æ‹¬æ¡¶çš„å®¹é‡ã€å¡«å……é€Ÿç‡å’Œè¯·æ±‚å¤„ç†çš„é˜ˆå€¼ã€‚
func (f *FlexibleLimiter) SetParams(capacity int, refillRate float64, limit int) {
    f.Lock() // ä½¿ç”¨äº’æ–¥é”è¿›å…¥ä¸´ç•ŒåŒºï¼Œé˜²æ­¢å¹¶å‘è®¿é—®å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚
    defer f.Unlock() // ç¦»å¼€ä¸´ç•ŒåŒºå‰è‡ªåŠ¨é‡Šæ”¾é”ã€‚

    // æ›´æ–°FlexibleLimiterçš„å‚æ•°ã€‚
    f.capacity, f.refillRate, f.limit = capacity, refillRate, limit
}

// Allow æ–¹æ³•æ ¹æ®FlexibleLimiterå½“å‰çš„å‚æ•°å†³å®šæ˜¯å¦å…è®¸æ–°çš„è¯·æ±‚ã€‚
// å®ƒé¦–å…ˆåŸºäºå½“å‰å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„RateLimiterV2å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„AllowWithFeedbackæ–¹æ³•ã€‚
func (f *FlexibleLimiter) Allow() (bool, string) {
    // æ ¹æ®FlexibleLimiterå½“å‰çš„å®¹é‡ã€å¡«å……é€Ÿç‡å’Œé˜ˆå€¼åˆ›å»ºä¸€ä¸ªæ–°çš„RateLimiterV2å®ä¾‹ã€‚
    rl := NewRateLimiterV2(f.capacity, f.refillRate, f.limit)
    
    // è°ƒç”¨RateLimiterV2çš„AllowWithFeedbackæ–¹æ³•ï¼Œè·å–æ˜¯å¦å…è®¸è¯·æ±‚çš„åé¦ˆã€‚
    // è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦å…è®¸è¯·æ±‚ï¼Œå’Œä¸€ä¸ªå­—ç¬¦ä¸²æ¶ˆæ¯æä¾›åé¦ˆä¿¡æ¯ã€‚
    return rl.AllowWithFeedback()
}
```

  

 5.3 é€æ˜æ€§

é€æ˜æ€§è¦æ±‚é™æµè§„åˆ™å’Œå½“å‰çŠ¶æ€å¯¹ç”¨æˆ·å¯è§ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿäº†è§£ä»–ä»¬è¢«é™æµçš„åŸå› å’Œæƒ…å†µã€‚

  

**ä¼ªä»£ç ç¤ºä¾‹ï¼š**

  

```
// TransparentLimiter ç»“æ„ä½“åµŒå…¥äº†RateLimiterV2ï¼Œæä¾›äº†é¢å¤–çš„çŠ¶æ€ä¿¡æ¯ï¼Œ
// åŒ…æ‹¬å½“å‰å‰©ä½™çš„ä»¤ç‰Œæ•°ï¼Œä»¥å¢å¼ºé™æµæœºåˆ¶çš„é€æ˜æ€§ã€‚
type TransparentLimiter struct {
    *RateLimiterV2 // åµŒå…¥RateLimiterV2ï¼Œè·å¾—å…¶æ‰€æœ‰åŠŸèƒ½ã€‚
    currentTokens int // å­˜å‚¨å½“å‰æ¡¶ä¸­å‰©ä½™çš„ä»¤ç‰Œæ•°ã€‚
}

// AllowWithStatus æ–¹æ³•å…è®¸è¯·æ±‚å¹¶è¿”å›å½“å‰é™æµçŠ¶æ€ã€‚
// å®ƒè°ƒç”¨å†…åµŒRateLimiterV2çš„AllowWithFeedbackæ–¹æ³•æ¥å†³å®šæ˜¯å¦å…è®¸è¯·æ±‚ï¼Œ
// å¹¶è·å–åé¦ˆæ¶ˆæ¯ï¼ŒåŒæ—¶è¿”å›å½“å‰å‰©ä½™çš„ä»¤ç‰Œæ•°ã€‚
func (t *TransparentLimiter) AllowWithStatus() (bool, string, int) {
    allowed, message := t.RateLimiterV2.AllowWithFeedback() // è°ƒç”¨å†…åµŒé™æµå™¨çš„å…è®¸é€»è¾‘ã€‚
    return allowed, message, t.currentTokens // è¿”å›æ˜¯å¦å…è®¸ã€æ¶ˆæ¯å’Œå½“å‰ä»¤ç‰Œæ•°ã€‚
}

// MiddlewareWithTransparency å‡½æ•°åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºåœ¨HTTPå“åº”ä¸­åŒ…å«é™æµçŠ¶æ€ã€‚
// è¿™ä¸ªä¸­é—´ä»¶åŒ…è£…äº†ä¸‹ä¸€ä¸ªhttp.Handlerï¼Œå¹¶åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰æ£€æŸ¥é™æµçŠ¶æ€ã€‚
func MiddlewareWithTransparency(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // åˆ›å»ºæˆ–ä½¿ç”¨å…¨å±€çš„transparentLimiterå®ä¾‹æ¥æ£€æŸ¥é™æµçŠ¶æ€ã€‚
        allowed, message, tokens := transparentLimiter.AllowWithStatus()

        // å¦‚æœè¯·æ±‚è¢«é™æµï¼ˆä¸å…è®¸ï¼‰ï¼Œåˆ™è®¾ç½®HTTPå¤´éƒ¨ä¿¡æ¯å’ŒçŠ¶æ€ç ï¼Œå¹¶è¿”å›é”™è¯¯æ¶ˆæ¯ã€‚
        if !allowed {
            w.Header().Set("X-RateLimit-Remaining", fmt.Sprintf("%d", tokens)) // è®¾ç½®å‰©ä½™ä»¤ç‰Œæ•°çš„å¤´éƒ¨ã€‚
            w.WriteHeader(http.StatusTooManyRequests)                             // è®¾ç½®HTTPçŠ¶æ€ç ä¸º429ã€‚
            fmt.Fprintln(w, message)                                            // å†™å…¥é”™è¯¯æ¶ˆæ¯åˆ°å“åº”ä½“ã€‚
            return                                                                // ä¸­æ–­è¯·æ±‚å¤„ç†ã€‚
        }

        // å¦‚æœè¯·æ±‚æœªè¢«é™æµï¼Œç»§ç»­æ‰§è¡Œåç»­çš„å¤„ç†é“¾ã€‚
        next.ServeHTTP(w, r)
    })
}
```

  

-End-

åŸåˆ›ä½œè€…ï½œç‹é¡ºé©°

  

æ„Ÿè°¢ä½ è¯»åˆ°è¿™é‡Œï¼Œä¸å¦‚å…³æ³¨ä¸€ä¸‹ï¼ŸğŸ‘‡

  

![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe975eiakGydXqTICibuXvLhyqN5sicc7ia7Cvb8nJGK2gjavrfIIYr5oicm20W8hFPvUdSm8UTzzWiaFco9Q/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

  

é™æµä¸»è¦ç»™é¡¹ç›®å¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„ï¼Ÿæ¬¢è¿è¯„è®ºåˆ†äº«ã€‚æˆ‘ä»¬å°†é€‰å–ç‚¹èµæœ¬æ–‡å¹¶ä¸”ç•™è¨€è¯„è®ºçš„ä¸€ä½è¯»è€…ï¼Œé€å‡ºè…¾è®¯äº‘å¼€å‘è€…å®šåˆ¶å‘è´¢æŒ‰é”® 1 ä¸ªï¼ˆè§ä¸‹å›¾ï¼‰ã€‚9 æœˆ 10 æ—¥ä¸­åˆ 12 ç‚¹å¼€å¥–ã€‚

  

![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe94vyO3fPZh9mVxibibSibCbtPqZcb58p44aSBWicmH6OPaCIBqZAbWd7pmx4wia4LLxjclTug439fzq0JQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

ğŸ“¢ğŸ“¢æ¬¢è¿åŠ å…¥è…¾è®¯äº‘å¼€å‘è€…ç¤¾ç¾¤ï¼Œäº«å‰æ²¿èµ„è®¯ã€å¤§å’–å¹²è´§ï¼Œæ‰¾å…´è¶£æ­å­ï¼Œäº¤åŒåŸå¥½å‹ï¼Œæ›´æœ‰é¹…å‚æ‹›è˜æœºä¼šã€é™é‡å‘¨è¾¹å¥½ç¤¼ç­‰ä½ æ¥~

![](https://mmbiz.qpic.cn/mmbiz_jpg/VY8SELNGe95yTGCsG3Yo5emBRh7nbAJybNbAp7TTMaGDiack9ngLFmyM3aCGAQmzqicDgaWicbRB5FPJVcRE7UWIg/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

ï¼ˆé•¿æŒ‰å›¾ç‰‡ç«‹å³æ‰«ç ï¼‰

  

![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe979Bb4KNoEWxibDp8V9LPhyjmg15G7AJUBPjic4zgPw1IDPaOHDQqDNbBsWOSBqtgpeC2dvoO9EdZBQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

[

![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe97aEd9icC2TgYXNticyuNibYOG2k1nGgz3SogoEHmzj5ibzBPkbhujoF36LGSBy3icHPYK78T3kj7ibehhQ/640?wx_fmt=png&from=appmsg)

](http://mp.weixin.qq.com/s?__biz=MzI2NDU4OTExOQ==&mid=2247678605&idx=1&sn=c720091348d50a547a0ca77b4b75a41b&chksm=eaa620ddddd1a9cb76fcc8441ea0ee785c649ba175e3fc551ee3c756783e93dc98660b3b5138&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe97BTISHsrl9zDdcmicFHsFpxeN083QWFpM7dmwqQ5V9lYic68fu4zJg9l55AMcYNMGWia8LfLJkrFOuQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)](http://mp.weixin.qq.com/s?__biz=MzI2NDU4OTExOQ==&mid=2247677031&idx=1&sn=a5d627c47d987bd8fe8f53ab27d8ed81&chksm=eaa62e37ddd1a721c300ac30d3a9c75b9dca023d3b32a6582a09799cf1084d2cf69e2e7d73b5&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe96DRb8KoX9d3zp2dT9oB83hBib8ltTuzsh3ib0KFf96qDMbKbGgOMdGAxbAO1CUCNmj3BxWc7BAMbDA/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)](http://mp.weixin.qq.com/s?__biz=MzI2NDU4OTExOQ==&mid=2247676682&idx=1&sn=7bd6ccc4099dc6ebe4a46281183b36cf&chksm=eaa6295addd1a04c04f5a41acec95cb91f04408655cbc9a1c760741c941d913bd71cfef53d45&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe95pIHzoPYoZUNPtqXgYG2leyAEPyBgtFj1bicKH2q8vBHl26kibm7XraVgicePtlYEiat23Y5uV7lcAIA/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)