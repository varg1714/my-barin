---
source: "[[阅读中/文章列表/Spring Boot 引起的 “堆外内存泄漏” 排查及经验总结 - 美团技术团队 - Cubox|Spring Boot 引起的 “堆外内存泄漏” 排查及经验总结 - 美团技术团队 - Cubox]]"
---

## 1. 🔍 问题背景

- **场景**: 项目迁移到基于 Spring Boot 的 MDP 框架后
- **现象**: 配置 4G 堆内存，但实际物理内存使用高达 7G，频繁触发 Swap 告警
- **JVM 配置**: `-Xmx4g -Xms4g` 等标准配置

## 2. 🛠️ 排查思路与工具链

### 2.1. Java 层面排查

**工具**: `jcmd pid VM.native_memory detail`
- **发现**: jcmd 显示的 committed 内存 < 实际物理内存
- **结论**: 存在 Native Code 申请的堆外内存，不在 JVM 管理范围内

### 2.2. 系统层面深入排查

**工具组合使用**:

| 工具 | 作用 | 关键发现 |
|-----|------|---------|
| `pmap` | 查看进程内存映射 | 发现大量 64M 内存块 |
| `gperftools` | 监控 malloc 申请的内存 | 内存使用在 700M-800M |
| `strace` | 追踪系统调用 | 启动时申请大量 64M mmap |
| `GDB dump` | 分析内存内容 | 发现 JAR 包解压数据 |
| `jstack` | 查看线程栈 | 定位到 MCC 扫包操作 |

### 2.3. 根因定位

通过线程栈分析发现：

```
MCC扫包 → Reflections → Spring Boot Loader → Inflater解压JAR → 堆外内存申请
```

## 3. 💡 根本原因分析

### 3.1. 问题链路

1. **MCC 默认扫描所有 JAR 包** → 触发大量 JAR 解压操作
2. **Spring Boot 的 ZipInflaterInputStream** → 使用 Inflater 申请堆外内存但不主动释放
3. **依赖 finalize 机制** → GC 时才释放堆外内存
4. **glibc 内存分配器策略** → 释放的内存保留在内存池中，不归还操作系统

### 3.2. 64M 内存块的真相

- **来源**: glibc 2.11+为每个线程引入的内存池
- **大小**: 64 位机器上每个内存池 64M
- **行为**: 为性能考虑，释放的内存不立即归还给 OS

## 4. ✅ 解决方案

### 4.1. 立即解决方案

```java
// 配置MCC扫包路径，避免扫描所有JAR包
@ComponentScan(basePackages = "com.specific.package")
```

### 4.2. 升级方案

- **Spring Boot 2.0.5+**: ZipInflaterInputStream 已修复，主动释放堆外内存

### 4.3. 其他可选方案

- 使用不同的内存分配器(如 tcmalloc)
- 自定义内存分配器(文章提供了 demo)

## 5. 📊 实验验证

| 内存分配器    | 扫包程度 | 物理内存占用 | 说明             |
| -------- | ---- | ------ | -------------- |
| glibc    | 全量扫包 | 7G+    | 内存池保留内存        |
| tcmalloc | 全量扫包 | ~800M  | 更好的内存回收        |
| 自定义分配器   | 全量扫包 | 1.7G   | mmap 直接分配，有页面浪费 |

## 6. 🎯 经验总结

### 6.1. 排查方法论

1. **分层排查**: Java 层 → 系统层 → 硬件层
2. **工具组合**: 单一工具有局限，需要交叉验证
3. **时机重要**: 有些问题需要在特定时机(如启动时)才能捕获

### 6.2. 关键技术点

- **Native Memory Tracking**: `-XX:NativeMemoryTracking=detail`
- **内存分配器影响**: glibc 的内存池机制可能导致"假泄漏"
- **Spring Boot 版本差异**: 不同版本的堆外内存管理策略不同

### 6.3. 预防措施

1. 合理配置组件扫描范围
2. 关注 Spring Boot 版本更新
3. 监控系统层面的内存指标，不仅仅是 JVM 指标
4. 了解底层内存分配器的行为特点

这个案例很好地展示了在复杂系统中，表面现象与根本原因可能相去甚远，需要系统性的排查思路和多层次的工具支撑。