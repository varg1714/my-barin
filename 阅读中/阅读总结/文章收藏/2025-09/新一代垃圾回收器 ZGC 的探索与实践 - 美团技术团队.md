---
source: "[[阅读中/文章列表/文章收藏/2025-09/新一代垃圾回收器 ZGC 的探索与实践 - 美团技术团队|新一代垃圾回收器 ZGC 的探索与实践 - 美团技术团队]]"
---

## 1. 文章核心内容分析

文章的核心是探讨 **ZGC (The Z Garbage Collector)** 如何解决传统垃圾回收器（如 CMS 和 G1）在高可用、低延迟服务中因“Stop The World”(STW)导致的停顿时间过长问题。作者通过理论结合实践，证明了 ZGC 在特定场景下的优越性。

## 2. 文章结构与要点

文章主要分为四个部分，层层递进：

1.  **GC 之痛 (The Pain of GC)**
    *   **问题提出**：低延迟服务（如风控）的可用性受到 GC 停顿的严重影响。
    *   **瓶颈分析**：分析了 CMS 和 G1 垃圾回收器的停顿瓶颈，指出其主要停顿时间来自于**标记-复制算法中的转移阶段**，这个阶段是 STW 的，且停顿时间与存活对象数量成正比。

2.  **ZGC 原理 (ZGC Principles)**
    *   **核心优势**：ZGC 最大的特点是其垃圾回收周期中的**标记、转移和重定位阶段几乎都是并发的**，从而将 STW 时间控制在 10ms 以内，且停顿时间不随堆大小或活跃对象数量增加。
    *   **关键技术**：
        *   **着色指针 (Colored Pointers)**：ZGC 利用 64 位指针的高位来存储元数据（如对象的标记状态），而不是将信息存储在对象头中。这使得状态更新非常快（寄存器操作）。
        *   **读屏障 (Read Barriers)**：当应用程序线程读取堆中对象时，会触发一小段代码（读屏障）。如果读屏障发现对象正在被转移或已经被转移，它会确保应用线程获得对象的新地址，从而实现了并发转移。
    *   **工作流程**：通过 M0、M1、Remapped 等地址空间的切换，配合着色指针和读屏障，实现了几乎完全并发的 GC 周期。

3.  **ZGC 调优实践 (ZGC Tuning in Practice)**
    *   **核心目标**：调优的主要目标是**避免因垃圾回收速度跟不上对象分配速度而导致的内存分配阻塞 (Allocation Stall)**。
    *   **重要参数**：介绍了 `-XX:ConcGCThreads` (并发回收线程数), `-XX:ZCollectionInterval` (固定时间间隔触发), `-XX:ZAllocationSpikeTolerance` (自适应算法修正系数) 等关键参数。
    *   **触发机制**：总结了 ZGC 的多种 GC 触发机制，如自适应算法、固定时间间隔、主动触发等。
    *   **调优案例**：分享了两个非常有价值的实战案例：
        1.  **内存分配阻塞**：针对流量突增（秒杀活动）或持续高压（压测）导致的性能毛刺，通过调整 `ZCollectionInterval` 和 `ZAllocationSpikeTolerance` 来更早、更及时地触发 GC，或通过增大 `ConcGCThreads` 加快回收速度。
        2.  **GC Roots 数量过大**：发现单次 GC 停顿时间较长，原因是 GC Roots（如 ClassLoader, CodeCache）数量过多。通过升级 Aviator 引擎版本解决了 ClassLoader 过多的问题，并通过业务优化减少了进入 CodeCache 的方法数量。
4.  **升级 ZGC 效果 (Upgrade Effects)**
    *   **延迟显著降低**：在低延迟场景下，TP999 和 TP99 指标均有大幅下降（18%~74%）。
    *   **吞吐量可能下降**：ZGC 为了追求低延迟，会消耗更多的 CPU 资源（单代回收、读屏障开销），因此不一定适合吞吐量优先的场景。

## 3. 总结与价值

*   **理论与实践结合**：这篇文章不仅深入浅出地解释了 ZGC 的核心原理，更宝贵的是提供了美团在真实生产环境中的调优经验和踩坑记录，具有很强的实践指导意义。
*   **问题导向**：从业务痛点出发，清晰地展示了为什么需要 ZGC，以及 ZGC 是如何解决这些痛点的。
*   **方法论**：附录部分还提供了升级新技术的通用方法论（评估收益、成本、风险），以及升级 JDK 11 的具体步骤和兼容性问题解决方案，非常全面。

总而言之，这是一篇高质量的技术实践分享，对于任何考虑在 Java 应用中使用 ZGC 来优化 GC 停顿的开发者来说，都具有极高的参考价值。