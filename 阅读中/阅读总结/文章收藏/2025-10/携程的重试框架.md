---
source:
  - "[[干货 _ 别让重试成为系统灾难，携程微服务重试治理之道]]"
create: 2025-10-24
---

## 1. 核心问题：重试的陷阱与风险

文章首先指出了传统重试机制（如简单的 for 循环重试）存在的两大问题：

1. **代码侵入性高**：重试逻辑与业务逻辑耦合，降低代码可读性。
2. **引发“重试风暴”**：在下游服务故障时，上游无脑重试，导致问题恶化。

“重试风暴”会带来以下几种灾难性后果：

* **链路放大效应**：如果调用链上的每个服务都配置了重试（例如，重试 3 次），一个初始请求在最底层服务失败后，可能导致请求量呈指数级增长（$n^4$），瞬间压垮整个链路。
* **告警升级**：放大的请求量会导致错误告警数量激增，干扰问题定位。
* **服务大规模不可用**：文章以一个真实线上事故为例，API 层的重试导致 5xx 错误翻倍，触发了 Nginx 的健康检查机制，自动摘除节点，最终导致整个服务不可用。
* **影响正常用户流量**：大量的重试请求会挤占系统资源，使得正常用户的请求无法得到处理，延长服务恢复时间。

## 2. 解决方案：SnailRetry 的优雅治理之道

为了解决上述问题，携程基于开源项目 SnailJob 落地了名为 SnailRetry 的服务治理重试组件。其核心思想是**不能让重试流量反客为主影响用户流量**。

### 2.1. 核心设计与架构

SnailRetry 采用**服务端**重试模式，与 Spring Retry 等客户端组件不同。它包含客户端（Client）和服务端（Server）两部分：

* **客户端**：通过注解（`@Retryable`）嵌入到业务代码中，负责在发生异常时上报重试任务。
* **服务端**：一个独立的平台，负责接收、持久化、调度和管理所有重试任务，并提供可视化的管理后台。

### 2.2. 关键功能与实现

- 流量管控（防止链路放大）
    这是 SnailRetry 的核心功能，通过多种方式实现：
    * **链路标记**：当一个请求是重试请求时，SnailRetry 会在请求头中加入特殊标识（如 `easyRetry:boolean`）。下游服务接收到带有此标识的请求后，即使执行失败也不会再次触发重试，从而保证重试只在调用链路的“最顶层”或“最底层”发生一次。
    * **特殊状态码**：约定一个特殊的 `status code`，表示“调用失败，但别重试”。当服务重试失败后，向上游返回此状态码，上游接收到后便会停止重试。
    * **流速管控**：根据当前服务的调用耗时和成功率，动态控制重试任务的执行速度，避免在下游服务已经高负载时火上浇油。

- 灵活的重试策略
    SnailRetry 提供三种重试模式，满足不同场景需求：
    * `ONLY_LOCAL`：本地内存重试，适用于短暂、临时的故障。
    * `ONLY_REMOTE`：直接上报服务端进行远程重试，适用于需要持久化保障的场景。
    * `LOCAL_REMOTE`：默认策略，先进行几次本地重试，如果仍然失败，再上报到服务端，兼顾了效率和可靠性。

- 可视化与动态配置
    * **数据大盘**：提供实时监控，展示系统健康度、重试成功率、失败场景等，帮助运维快速定位问题。
    * **后台动态配置**：可以在管理后台为每个重试场景精细化配置重试次数、间隔、超时时间、告警策略等，无需修改代码和重新部署。

- 丰富的回调与告警机制
    * **回调任务**：当远程重试任务最终成功或达到最大次数后，可以回调客户端的指定方法。这使得业务方能感知到任务的最终状态，并执行相应的兜底逻辑（如发送告警、通知上游业务失败）。
    * **告警策略**：支持自定义告警阈值，当重试任务总数、失败次数等指标超标时，能及时通知运维人员。

## 3. 适用场景

文章列举了 SnailRetry 的几个典型应用场景：

1. **异步场景**：如下单后的非核心流程（发短信、加积分），通过 MQ 或异步线程处理，使用 SnailRetry 保证任务最终成功。
2. **回调场景**：如携程机车合销的履约失败退赔流程，需要感知重试最终是否成功，以便通知相关业务方。
3. **同步阻塞场景**：将重试任务转移到 SnailRetry 服务端，避免调用方线程长时间阻塞。
4. **消息队列场景**：作为 MQ 自带重试机制的补充，提供更强的可观测性和精细化管理能力，保障消息的强可达性。

## 4. 总结

这篇文章清晰地阐述了微服务中重试机制的潜在风险，并提供了一个经过实践检验的、体系化的解决方案——SnailRetry。它通过**流量管控、服务端调度、可视化管理和动态配置**等手段，将重试从一个不可控的风险点，转变为一个安全、可靠、可观测的系统稳定性保障措施，实现了“优雅重试”。