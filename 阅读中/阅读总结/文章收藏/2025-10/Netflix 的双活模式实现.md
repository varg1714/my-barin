---
source: "[[双活模式实现多区域弹性 _ Netflix 技术博客 _ Netflix TechBlog --- Active-Active for Multi-Regional Resiliency _ by Netflix Technology Blog _ Netflix TechBlog双活模式实现多区域弹性_ Netflix 技术博客 _ Netflix 技术博客 --- 主动-主动实现多区域弹性 _ Netflix 技术博客 _ Netflix 技术博客]]"
create: 2025-10-02
---

## 1. 核心思想与架构

Netflix 的双活架构将用户请求路径上的所有服务同时部署在美国的两个 AWS 区域（弗吉尼亚州的 `us-east-1` 和俄勒冈州的 `us-west-2`）。

* **正常状态**：用户通过地理位置 DNS 被路由到最近的区域，两个区域大致各分担 50% 的流量。
* **故障状态**：当一个区域出现严重故障时，Netflix 可以通过工具将所有用户流量快速切换到健康的区域。

## 2. 实现双活架构的关键挑战与解决方案

文章重点介绍了实现这一架构所面临的三大技术挑战及其解决方案：

1. **流量控制与引导 (Traffic Directing)**
    * **挑战**：如何精确、快速地控制全球用户流量的走向。
    * **解决方案**：
        * 使用自研的 `Denominator` 工具统一管理多个 DNS 提供商。
        * 结合使用 **UltraDNS**（用于基于地理位置的定向路由）和 **Route53**（API 响应快，用于快速切换 CNAME 记录），实现灵活且可靠的流量调度。

2. **流量整形与负载保护 (Traffic Shaping & Load Shedding)**
    * **挑战**：在流量切换时，如何防止瞬间涌入的巨大流量（惊群效应）冲垮健康区域的服务。
    * **解决方案**：利用边缘网关服务 `Zuul`。
        * **识别错误路由**：确保用户会话不会跨区域。
        * **声明“故障转移”模式**：在故障时，让当前区域处理所有请求，而不是尝试转发。
        * **负载削减**：定义流量上限，当请求超过阈值时自动拒绝多余请求，保护下游服务在扩容或缓存预热期间不被压垮。

3. **跨区域数据/状态复制 (Data Replication)**
    * **挑战**：如何保证分布在不同区域的数据能够快速、可靠地同步，同时服务本身保持无状态。
    * **解决方案**：
        * **持久化数据**：使用 **Apache Cassandra**。它天然支持多数据中心异步复制，Netflix 的实验证明其复制延迟在可接受范围内（500ms 内）。
        * **缓存数据**：使用自研的 **EvCache**（基于 Memcached 的客户端）。当一个区域发生数据写入时，EvCache 客户端会通过 SQS 向另一区域发送消息，使其对应的缓存条目失效。这样，下次读取时就会穿透到 Cassandra 获取最新数据并更新本地缓存。

## 3. 自动化与测试

为了确保这套复杂系统的稳定性和可靠性，Netflix 采取了以下措施：

* **自动化部署 (`Mimir`)**：开发了名为 `Mimir` 的工作流工具，用于自动化跨多个区域的部署、金丝雀分析和自动回滚，减少了手动操作的复杂性和风险。
* **混沌工程 (Simian Army)**：通过“猿猴军团”模拟各种故障场景来验证架构的弹性。
    * **Chaos Gorilla**：模拟单个可用区（AZ）故障。
    * **Split-brain (脑裂)**：模拟区域间的网络连接中断，验证各区域的独立运作能力。
    * **Chaos Kong**：模拟最大规模的区域级故障，进行真实的跨区域流量迁移演练，验证整个故障转移流程。

## 4. 总结

这篇文章展示了 Netflix 如何通过一系列自研工具（`Denominator`, `Zuul`, `EvCache`, `Mimir`）和开源技术（`Cassandra`），并结合混沌工程的实践，成功构建了一个强大的多区域双活系统。这不仅提升了其服务的弹性和可用性，也为处理大规模、高速度变更下的系统故障提供了宝贵的工程经验。该项目最终的成功，还得益于优秀的工程师团队和 AWS 快速提供资源的能力。