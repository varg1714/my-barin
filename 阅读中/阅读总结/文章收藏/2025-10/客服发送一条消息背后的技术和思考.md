---
source:
  - "[[客服发送一条消息背后的技术和思考｜得物技术]]"
create: 2025-10-29
---

## 1. 四大支柱：技术实现与架构思考

一个健壮的 IM 系统，可以看作由以下四大技术支柱支撑：

### 1.1. 可靠性 (Reliability) - 系统的基石

确保消息 `At least once` (至少一次) 送达，且顺序正确、不重复。

* **核心机制：应用层 ACK**
    * **问题**：TCP 的可靠性仅限于传输层，无法保证应用间的消息送达。
    * **方案**：实现应用层的 ACK 确认机制。发送方未在超时内收到接收方的 ACK，则会重试。
    * **权衡**：为避免高频 ACK 带来的性能开销，针对批量消息（如拉取历史记录）采用**批量 ACK** 机制，在可靠性与成本间找到平衡。
* **有序性：建立唯一事实来源 (Single Source of Truth)**
    * **问题**：并发操作（如边传文件边发消息）、网络延迟等极易导致消息乱序。
    * **方案**：以中心化的 **IM 网关生成的序列号 (Seq)** 作为唯一排序标准，客户端严格按 Seq 排序，杜绝混乱。
* **幂等性：处理不可避免的重复**
    * **问题**：ACK 重试机制必然导致消息重复的可能。
    * **方案**：为每条消息生成唯一的 **Message ID**，接收端根据此 ID 进行去重，保证消息只被处理一次。

### 1.2. 性能 (Performance) - 流畅的保障

在高并发、大数据量下，如何避免用户感知的“卡顿”。

* **数据处理优化：算法的力量**
    * **反面教材**：第三方 SDK 的低效 `for` 循环在大量消息下崩溃。
    * **自研优化**：重写 SDK，将会话抽象为独立实例，采用**二分法**等高效算法处理消息的排序、去重、更新，从 O(n) 优化到 O(log n) 级别，根治卡顿。
* **前端渲染优化：只做必要的事**
    * **方案**：采用虚拟列表技术，通过 `requestAnimationFrame` 或 `IntersectionObserver`，只渲染可视区域的消息，极大降低浏览器负担。
    * **难点**：IM 消息高度不定的场景下，计算成本较高，需要精细优化。
* **任务调度：区分优先级**
    * **方案**：利用**异步处理**机制，将高优任务（如发送消息后立即在界面显示）放在主线程，低优任务（如接收消息、后台同步）推入异步队列，保证关键操作的即时响应。

### 1.3. 效率 (Efficiency) - 极致的压榨

降低延迟和系统资源消耗。

* **核心策略：ProtoBuf 替换 JSON**
    * **权衡**：牺牲 JSON 的人类可读性和调试便利性，换取巨大的性能收益。
    * **收益**：ProtoBuf 作为二进制格式，**体积更小、编解码更快**，能显著降低网络带宽消耗和客户端处理延迟。
* **辅助策略：消息压缩**
    * 针对历史消息、批量消息等场景，通过压缩算法进一步减小数据包体积。

### 1.4. 体验 (User Experience) - 最终的目标

技术最终要服务于人。

* **重新定义“卡顿”**：深刻洞察到客服用户对“卡顿”的定义是广义的，包括**接口慢、错误提示、页面白屏、UI 响应不及时**等一切影响工作流的因素。这要求技术优化必须以**用户可感知的流畅度**为目标。
* **面向专业用户设计**：客服是高频、高强度的专业用户（“300ms 间隔发消息”），对工具的容忍度极低。系统必须能承受这种极限场景的考验。

---

## 2. 三大核心工程哲学

比技术细节更具指导意义的是其背后蕴含的工程思想。

### 2.1. 从“修补匠”到“架构师”的思维转变

* **自研的决心**：果断放弃无法满足核心场景的第三方依赖，通过**重写核心 SDK**，将系统命运牢牢掌握在自己手中。这是从被动修补到主动设计的关键一步。
* **系统性治理**：通过“**IM 架构升级技术专项**”的方式，从根源上系统性解决一类问题（如消息丢失），而非零散地修复 Bug，极大提升了长期工程效率。

### 2.2. 精妙的务实主义与权衡 (Trade-off)

架构设计是权衡的艺术，文中处处体现了在约束下的最优决策。

* **可靠性 vs. 成本**：`单条 ACK` vs. `批量 ACK`
* **开发体验 vs. 运行性能**：`JSON` vs. `ProtoBuf`
* **实现简单性 vs. 系统一致性**：`客户端时间` vs. `网关 Seq`

### 2.3. 全链路视野与协同作战

* **跳出前端看问题**：虽然是前端视角，但所有核心问题的解决方案（ACK、Seq、ID 去重）都依赖于**端到端**的设计和前后端的紧密配合。
* **团队协同的价值**：项目的成功是 H5、网关、服务端、客户端等多团队协同的结果，体现了现代复杂应用开发中跨越技术边界的系统性思维至关重要。