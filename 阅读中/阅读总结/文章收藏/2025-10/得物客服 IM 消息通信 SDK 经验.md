---
source:
  - "[[得物客服 IM 消息通信 SDK 自研之路]]"
create: 2025-10-29
---

## 1. 自研背景与动机

* **初期问题**: 项目初期为了快速上线，采用了第三方 SDK 进行二次开发。但这导致了**问题定位困难**、**特殊功能（如敏感词处理、断网重连等）实现成本高**等隐患。
* **核心驱动力**: 随着业务快速发展，对 IM 的性能和用户体验要求越来越高，第三方 SDK 成为瓶颈。为了获得一个**可控、稳定、高扩展性**的 IM 系统，自研势在必行。

## 2. 核心设计理念

文章开篇就指出了设计的核心目标：**保证用户体验的流畅性，避免卡顿**。为实现这一目标，SDK 的设计围绕以下两点展开：

1. **合理的发送策略**: 优化消息发送流程，优先保障 UI 渲染。
2. **避免大量 JS 脚本执行**: 减少不必要的计算和性能浪费。

## 3. 技术架构与分层实现

文章提出的自研 SDK 框架是一个清晰的三层结构，并利用发布订阅模式实现解耦。

![](https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74AyIMpnZEFomz0CL4CFSJphZoTvRXk8ictsLUmkqicdMibdrbSIiavb0UMhshE9FSjjONRC5pxb2ZC6UQ/640?wx_fmt=png#imgIndex=1)

### 分层设计

1. **网络层 (Network Layer)**
    * **职责**: 负责底层的 TCP 连接、消息收发。
    * **技术选型**: 采用 **TCP 协议** 以保证数据传输的可靠性（无差别、不丢失、不重复、按序到达）。
    * **关键技术**: 实现了**指数退避（Exponential Backoff）**的超时重连机制。当连接断开时，重试的间隔会逐渐加长，避免在网络恢复的瞬间因大量并发重连请求而冲垮服务器。

2. **数据链路层 (Data Link Layer)**
    * **职责**: SDK 的核心，处理用户信息、消息体、数据池、消息排序和可靠性投递。
    * **关键实现 - 消息发送流程**: 为了极致的用户体验，采用了**“先渲染后发送”**的策略。当客服点击发送后，消息会立即在本地创建并渲染到聊天界面，然后再通过网络发送到网关。这让客服感觉消息是“秒发”的，避免了等待网络响应的卡顿感。
    * **关键实现 - 消息可靠性保障**: 这是整个 SDK 技术含金量最高的部分，通过组合多种机制来确保消息**不丢、不重、不乱**。
        * **ACK 机制**: 借鉴 TCP 协议，在业务层实现了一套确认机制。接收方收到消息后会回复一个 ACK 包，告知发送方“我已收到”。
        * **重试机制**: 在客户端和网关都设置了超时计时器。若在规定时间内未收到 ACK，则自动重发消息。
        * **去重机制**: 每条消息都有一个全局唯一的 `msgid`。接收方根据 `msgid` 判断消息是否重复，避免因重试导致界面上出现多条相同的消息。
        * **排序机制**: 消息的顺序不依赖于客户端本地时间（可能不准），而是依赖于**IM 网关生成的、自增的 `seqid`**。所有客户端都根据这个权威的 `seqid` 进行排序，保证了消息顺序的一致性。

3. **应用层 (Application Layer)**
    * **职责**: 暴露简洁的接口供业务侧调用。
    * **关键技术**: 使用 **RxJS** 实现了发布订阅模式。SDK 底层作为发布者（Observable），业务侧作为订阅者（Observer）。这种方式**清晰地解耦了 SDK 内核与业务逻辑**，使得业务方可以灵活地监听和消费消息，并且可以随时取消订阅，维护成本低。

## 4. 挑战与总结

* **复杂场景的考虑**: 文章强调，自研过程并非一帆风顺，需要充分考虑各种极端和复杂的业务场景，例如：
    * 断网/弱网环境下的消息发送、排序和重试。
    * 消息发送失败后的状态显示。
    * 敏感词消息的处理。
    * 文件类消息的特殊处理。
* **收益与展望**:
    * **巨大收益**: 成功自研不仅解决了业务痛点，还为团队积累了宝贵的 IM 领域经验。
    * **未来方向**: 完成 SDK 只是第一步，未来将在**耗时任务处理**和**数据安全**等方面持续深耕。

## 总结分析

这篇文章不仅是一篇技术实践分享，更是一份高质量的 IM SDK 设计指南。它从业务痛点出发，清晰地展示了如何通过分层架构、精巧的流程设计和可靠的机制组合，构建一个高性能、高可用的实时通信系统。

其最大的亮点在于对**消息可靠性**的深刻理解和完整实现方案，以及对**用户体验**的极致追求（如“先渲染后发送”）。对于任何需要构建或理解 IM 系统的开发者来说，这都是一篇非常有价值的参考。