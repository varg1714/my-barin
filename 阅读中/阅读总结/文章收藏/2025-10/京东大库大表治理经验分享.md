---
source:
  - "[[记一次大库大表的治理过程]]"
create: 2025-10-29
---

## 1. 核心问题背景

文章描述了一个核心应用数据库面临的严峻挑战，主要体现在四个方面：

1. **硬件老旧与瓶颈**：
    * 一主两从物理机，均已过保，存在硬件故障风险。
    * 其中一个从库配置低（内存减半、机械硬盘），性能差，增加了系统的不稳定性。
    * 无法增加新从库以分担压力。

2. **磁盘空间告急**：
    * 主库磁盘使用率已达 `69%`，且持续增长。
    * 存在多张亿级行数、百 G 以上体积的超大表，最大一张表达 `30亿` 行。

3. **主库压力巨大**：
    * 应用中大部分查询请求直连主库，导致主库 QPS 远高于从库，高峰期达到 `25k`。
    * 读写分离实践不足，主库承担了大量本可由从库处理的读请求。

4. **慢 SQL 频发**：
    * 主从库均存在偶发性慢 SQL，导致磁盘 IO 繁忙，影响整体服务稳定性。
    * 特别是存在无任何查询条件的“全表扫描”式查询。

## 2. 治理目标（可量化）

为应对上述问题，团队设立了清晰且可量化的治理目标：

* **数据结转**：将 7 张核心大表数据保留期缩短至 365 天，显著降低磁盘使用率。
* **主库降压**：将主库白天 QPS 峰值降低 `30%`（从 `25k` 降至 `18k` 左右）。
* **慢 SQL 治理**：
    * `10s` 以上慢 SQL：彻底消除。
    * `5s` 以上慢 SQL：消除 `80%`。
    * `1s` 以上慢 SQL：消除 `60%`。

## 3. 核心治理方案与实施

### 3.1. 数据结转与清理：分类处理，释放空间

这是解决磁盘空间问题的直接手段。方案的关键在于**根据业务属性分类处理**，而非一刀切删除。

* **策略分类**：
    1. **直接删除**：对于无历史价值的数据（如 `xxx_exception` 异常记录表），直接删除过期数据。
    2. **归档后删除**：对于流水型数据（如 `xxx_status` 状态表），先同步至大数据平台供分析使用，然后删除。
    3. **结转至历史库**：对于核心业务主数据（如 `xxx_main` 主表），同步到大数据平台的同时，也结转至专门的历史数据库。
* **成果**：在一个月内，通过上述操作，成功将数据保留在 365 天范围内，共释放了 **470G** 的磁盘空间（约占总量的 10%）。

### 3.2. 读写分离优化：数据驱动，精准切流

这是降低主库 QPS 的核心方案。方案的亮点在于**数据驱动，精准定位**高频接口。

* **识别高频接口**：
    1. **数据采集**：利用 `JSF Filter` 拦截服务调用，并通过 `UMP` 业务监控系统记录各接口的调用次数。
    2. **数据分析**：编写 `Python` 脚本，定时拉取 UMP 的监控数据，生成 Top 10 调用量接口的统计报表。
* **实施切换**：
    * 分析 Top 10 接口的业务逻辑，判断是否可以安全地切换到从库查询。
    * 对于纯查询且对数据一致性要求不高的接口，在 Service 层通过注解等方式，将数据源切换至从库。
    * 对于被多处引用的方法，为避免影响原有业务，采用**新增 API 接口**的方式进行隔离切换。
* **成果**：成功将主库 QPS 峰值从 `25k` 降低到 **17.5k**，实现了降低 `30%` 的目标。

### 3.3. 慢 SQL 治理：主动防御与被动优化结合

此方案双管齐下，既解决存量问题，也预防未来问题。

* **主动防御：拦截无参数查询**
    * **问题**：偶发的无参数查询会导致全表扫描，严重影响数据库性能。由于调用入口复杂，在业务层拦截风险高。
    * **方案**：开发一个 **MyBatis 拦截器 (Interceptor)**，在 DAO 层执行 SQL 前进行检查。如果发现是指定需要拦截的查询方法且参数列表为空，则直接抛出异常并告警，从根源上杜绝此类慢 SQL。
* **被动优化：常规慢 SQL 治理**
    * 针对监控到的其他慢 SQL，采用常规优化手段（如添加索引、改写 SQL 逻辑等）。
    * 强调了**灰度发布**和充分验证的重要性，确保优化不会引入新问题。
* **成果**：达成了预设的慢 SQL 治理目标，系统稳定性显著提升。

## 4. 方案探讨与未来规划

文章最后探讨了两种更彻底但当前未采纳的方案，体现了技术选型的务实性。

* **分库分表**：由于当前业务增长稳定，实施分库分表的改造成本高、风险大，**ROI (投入产出比) 不高**。
* **迁移上云**：迁云需要结合分库分表，且在线迁移流程复杂（双写、数据同步、一致性校验等），成本和风险更高。

**未来规划**：如果业务量再次大幅增长，现有治理方案达到极限时，将启动**“迁云 + 分库分表”**的长期演进方案。

## 5. 个人总结与启示

1. **数据驱动决策**：无论是切流还是优化慢 SQL，都依赖监控数据（UMP、慢 SQL 日志）来定位问题，而不是凭感觉。这是高效治理的前提。
2. **方案务实，看重 ROI**：没有盲目追求“分库分表”等“银弹”，而是选择了风险更低、见效更快的组合拳，体现了成熟的工程思维。
3. **主动防御优于被动修复**：MyBatis 拦截器是一个绝佳的“主动防御”范例。通过在底层框架设卡，可以一劳永逸地解决一类问题，比事后反复救火要高效得多。
4. **治理是系统工程**：单一手段难以解决复杂问题。本文的成功在于结合了**数据层（清理）、应用层（读写分离）和框架层（拦截器）**的多维度治理。
5. **量化目标，量化成果**：所有治理工作都围绕清晰的量化指标展开，这使得工作目标明确，成果也易于衡量和展示。