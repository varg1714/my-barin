---
source:
  - "[[阅读中/文章列表/文章收藏/2025-11/得物 TiDB 升级实践|得物 TiDB 升级实践]]"
create: 2025-11-23
---

## 1. 背景与动因

得物 DBA 团队将 TiDB 集群从旧版本（主要为 v5.3.3，部分 v4.x）升级至 **v7.5.x**。

* **原有痛点**：
    * **版本过低**：v4/v5 官方停止维护，无法享受新特性。
    * **组件风险**：旧版 TiCDC 存在同步延迟和 OOM 风险。
    * **运维瓶颈**：备份耗时过长（>8 小时），且备份期间集群负载高，影响业务 RT。
    * **稳定性**：偶发慢查询抖动，旧版 TiKV 运行超 2 年自动重启等 BUG。

## 2. 升级策略：迁移升级 (Migration Upgrade)

得物选择了**迁移升级**而非原地升级。

* **方案对比**：
    * *原地升级*：简单但不可回退，升级期间抖动大，跨大版本风险高。
    * *迁移升级*：搭建新集群 -> 同步数据 -> 流量切换 -> 销毁旧集群。
* **实施步骤**：
    1. **集群调研与准备**：确定 v7.5.x 为目标版本，准备新环境。
    2. **数据同步**：使用 TiCDC 或其他工具进行全量+增量同步。
    3. **验证**：在新集群进行功能和性能验证。
    4. **流量迁移**：通过 SLB 或应用配置切换流量。
    5. **销毁**：确认无误后下线旧集群。
* **优缺点分析**：虽然成本暂时增加（需要额外硬件），但业务影响最小，具备灰度能力和回滚能力，适合核心业务。

## 3. 升级中遇到的技术问题 (关键)

升级到 v7.5.x 后，虽然整体性能提升，但优化器行为改变导致了部分 SQL 性能回退。

| 问题现象 | 原因分析 | 解决方案 |
| :--- | :--- | :--- |
| **倾向全表扫描** | 存在合理索引，但优化器偏好全表扫描 (Table Scan)，导致超时。 | 1. 使用 SPM (SQL Plan Management) 绑定执行计划。<br>2. 调整参数 `tidb_opt_prefer_range_scan = ON`。 |
| **聚合查询索引失效** | 聚合或大范围统计查询无法命中有效索引，执行计划不准确。 | 调整参数 `tidb_opt_objective = determinate`，不再完全依赖实时统计信息，使计划更稳定。 |

## 4. 升级收益

* **性能提升**：应用平均 RT 降低约 **44.62%** (从 ~16.9ms 降至 ~9.36ms)，毛刺显著减少。
* **备份效率**：备份时间缩短 **50%** 以上，降低了对业务高峰期的影响。
* **存储成本**：新版压缩算法更优，TiDB 3 副本数据大小仅为 MySQL 主实例的 **55%**。
* **功能增强**：
    * TiCDC 同步性能提升数十倍。
    * 支持 TTL (Time-To-Live) 自动清理过期数据。
    * 资源管控 (Resource Control) 能力增强。

## 5. 架构选型逻辑：TiDB vs MySQL

文章非常客观地指出了 TiDB 的适用场景，并未盲目推崇。

* **优先 MySQL**：
    * 能通过标准分库分表解决的问题。
    * 对单点查询速度（Point Select）、单机 QPS 要求极高的场景。
    * 运维成本敏感型场景。
* **选择 TiDB**：
    * **非分片/复杂查询**：上游 MySQL 已分片，但下游需要跨分片聚合查询或复杂分析。
    * **HTAP 需求**：同时存在高并发事务和实时分析需求。
    * **磁盘瓶颈**：MySQL 单机磁盘容量不足，但 CPU/内存富余。
    * **数据倾斜**：电商大卖家等导致的数据倾斜，MySQL 分库分表难以处理热点，TiDB 可通过打散 Region 解决。

## 6. 总结与评价

* **客观性**：文章不仅展示了升级后的 RT 提升图表，也详细记录了升级后遇到的优化器“负优化”问题及具体参数修复方法，具有很高的工程参考价值。
* **架构演进**：体现了从“能用”到“好用”的演进。从 v4/v5 的基础使用，到 v7 利用 TTL、资源管控等高级特性。
* **建议**：对于准备升级 TiDB 到 v7+ 的团队，需重点关注 SQL 执行计划的回归测试（Plan Replayer），特别是针对大表的范围查询和聚合查询。